<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sierpinski Project</title>
  <style>
    :root {
      --bg:#0b1117; --panel:#0e141b; --muted:#8aa0b4; --fg:#e7eef5;
      --accent:#5ba8ff; --border:#1b2632; --ok:#37c978; --warn:#ffb020; --err:#ff5a5a;
      --content-max:1320px; --content-pad:32px;
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--fg);
      background: linear-gradient(rgba(11,17,23,.86), rgba(11,17,23,.86)),
                  url('background.png') center/cover fixed no-repeat;
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{width:min(var(--content-max), 100% - var(--content-pad)*2); margin:0 auto}
    header{position:sticky; top:0; z-index:5; background:var(--panel); border-bottom:1px solid var(--border)}
    header .inner{display:flex; align-items:center; justify-content:space-between; padding:12px 0}
    .title{display:flex; gap:12px; align-items:baseline}
    .title h1{margin:0; font-size:18px}
    .title span{color:var(--muted); font-size:13px}
    .header-right{display:flex; align-items:center; gap:10px}
    .manifest-chip{
      display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted);
      border:1px solid var(--border); padding:6px 8px; border-radius:8px; background:#0c131a; white-space:nowrap;
    }
    .dot{width:8px; height:8px; border-radius:50%; background:var(--warn); flex:0 0 8px}
    .dot.ok{background:var(--ok)} .dot.err{background:var(--err)}
    .lang{display:flex; align-items:center; gap:8px}
    .lang label{color:var(--muted)}
    .lang select{background:#0e141b; color:var(--fg); border:1px solid #26303c; border-radius:8px; padding:6px 10px}
    .refresh{background:#0f1922; border:1px solid #26303c; color:var(--fg); padding:6px 10px; border-radius:8px; cursor:pointer}
    .refresh:hover{background:#122436}

    .app{display:grid; grid-template-columns:360px 1fr; min-height:calc(100vh - 56px); gap:24px; padding:18px 0 28px}
    .left,.right{border:1px solid var(--border); background:#0c1218; border-radius:12px; overflow:auto}
    .left .section{padding:12px 14px; border-bottom:1px solid var(--border)}
    .section h2{margin:0 0 8px; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em}
    .search{padding:0 14px 12px; border-bottom:1px solid var(--border)}
    .search input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #24303c; background:#0f1720; color:var(--fg)}
    .crumb{padding:8px 14px; border-bottom:1px solid var(--border); font-size:12px; color:var(--muted)}
    .crumb a{color:var(--muted)} .crumb a:hover{color:var(--fg)}
    .list{list-style:none; margin:0; padding:6px}
    .item{display:grid; grid-template-columns:24px 1fr auto; align-items:center; gap:10px; padding:8px 10px; border-radius:8px; cursor:pointer; color:#fff}
    .item:hover{background:#111a23}
    .item .name{overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .item .meta{color:var(--muted); font-size:12px}
    .item.active{background:#122236}

    .viewer{padding:18px 22px 60px}
    .viewer .bar{display:flex; align-items:center; gap:8px; justify-content:space-between; position:sticky; top:0; padding:10px 0; background:#0c1218; z-index:3}
    .viewer .btns{display:flex; gap:8px}
    .btn{background:#0f1922; border:1px solid #26303c; color:var(--fg); padding:8px 10px; border-radius:8px; cursor:pointer}
    .btn:hover{background:#122436}
    .muted{color:var(--muted)}
    .md,.generic{max-width:980px; margin:0 auto}
    .md h1,.md h2,.md h3,.md h4{margin-top:1.6em}
    .md pre{background:#0f1922; padding:12px; border-radius:10px; overflow:auto; border:1px solid #223042}
    .md code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .md table{border-collapse:collapse; border:1px solid #223042}
    .md table th,.md table td{border:1px solid #223042; padding:6px 8px}
    .md img{max-width:100%}
    .viewer .preview,.viewer img.preview,.viewer video.preview,.viewer audio.preview{
      width:100%; max-width:980px; border:1px solid #223042; border-radius:10px; background:#0f1922; display:block; margin:0 auto;
    }
    .viewer img.preview{height:auto}
    pre.codebox{background:#0f1922; padding:12px; border-radius:10px; overflow:auto; border:1px solid #223042; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; white-space:pre; max-height:78vh}

    footer{border-top:1px solid var(--border); padding:10px 0; color:var(--muted); background:var(--panel)}
    footer .inner{display:flex; align-items:center; justify-content:space-between}

    @media print{
      header,.left,.viewer .bar,footer{display:none !important}
      .app{display:block}
      body{background:#fff; color:#000}
      .md pre,pre.codebox{border:1px solid #ccc; background:#fafafa; color:#111}
    }
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
  <!-- PDF.js Legacy (setzt window.pdfjsLib) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/legacy/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/legacy/build/pdf.worker.min.js";
  </script>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

  <!-- i18n runtime -->
  <script src="assets/i18n.js"></script>
</head>
<body>
<header>
  <div class="container inner">
    <div class="title">
      <h1 data-i18n="app.title">Sierpinski-Tetraeder – Projekt</h1>
      <span class="muted" data-i18n="app.subtitle">Experiment, Dokumentation und Materialien</span>
    </div>
    <div class="header-right">
      <button id="btnRefresh" class="refresh" title="Index aktualisieren">↻</button>
      <div id="manifestChip" class="manifest-chip" title="manifest.json">
        <span class="dot" id="manifestDot"></span>
        <span id="manifestText">manifest…</span>
      </div>
      <div class="lang">
        <label for="langSelect" data-i18n="app.language">Sprache</label>
        <select id="langSelect" aria-label="Language">
          <option value="de">Deutsch</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <section class="app">
    <aside class="left">
      <div class="section"><h2 data-i18n="browser.title">Dateibrowser</h2></div>
      <div class="search">
        <input id="q" type="search" placeholder="Suchen …"
               data-i18n="search" data-i18n-attr="placeholder" data-i18n-search="search.placeholder">
      </div>
      <div class="crumb" id="crumb"></div>
      <ul id="list" class="list"></ul>
    </aside>

    <section class="right">
      <div class="viewer">
        <div class="bar">
          <div class="muted" id="currentName">—</div>
          <div class="btns">
            <button id="btnOpenRaw" class="btn" data-i18n="viewer.openRaw">Rohdatei öffnen</button>
            <button id="btnCopyLink" class="btn" data-i18n="viewer.copyLink">Link kopieren</button>
            <button id="btnPdf" class="btn" data-i18n="viewer.downloadPdf">Als PDF exportieren</button>
            <button id="btnRunPy" class="btn" style="display:none" data-i18n="viewer.runPy">Python ausführen</button>
          </div>
        </div>
        <article id="md" class="md" hidden></article>
        <div id="generic" class="generic" hidden></div>
      </div>
    </section>
  </section>
</main>

<footer>
  <div class="container inner">
    <span id="copyright"></span>
    <span class="muted">antaris82.github.io</span>
  </div>
</footer>

<script>
/* ===================== Manifest + Dateibrowser ===================== */
let MANIFEST=null; let NODES=new Map(), CHILDREN=new Map();
let cwd="", lastMdBasePath=null, currentRawUrl=null, currentShareUrl=null; let lastManifestTs=0;

/* ---- Start-Ordner (User-Wunsch) ---- */
const START_PATH = "Sierpinskir Tetraeder_PoC"; // wird benutzt, falls im Manifest vorhanden

const pathDir=p=> (p.split("/").slice(0,-1).join("/"));
const baseName=p=> (p.split("/").pop()||"");
const ext=name=> (name.toLowerCase().match(/\.([a-z0-9]+)$/)?.[1]||"");
const isTextExt=e=>["txt","log","md","markdown","csv","tsv","json","xml","yml","yaml","ini","conf","sh","py","js","ts","css","html","svg","java","c","cpp","h","hpp","cs","go","rs","php","rb","kt","swift","sql","toml"].includes(e);
const isImageExt=e=>["png","jpg","jpeg","gif","webp","avif","bmp","svg"].includes(e);
const isAudioExt=e=>["mp3","wav","ogg","m4a","aac","flac"].includes(e);
const isVideoExt=e=>["mp4","webm","ogv","mov"].includes(e);
const isPdfExt=e=>e==="pdf";
const fmtSize=b=>{if(b==null||isNaN(b))return"";const u=["B","KB","MB","GB","TB"];let i=0,n=+b;while(n>=1024&&i<u.length-1){n/=1024;i++;}return (Math.round(n*10)/10)+" "+u[i];};
const urlFor=p=> encodeURI((p||"").replace(/^\/+/,""));
async function fetchJSON(u){const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json();}
async function fetchText(u){const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.text();}
async function fetchArrayBuffer(u){const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.arrayBuffer();}

/* ---- Share-Link heuristisch bestimmen ---- */
function computeShareLink(path){
  const clean = (path||"").replace(/^\/+/,"");
  const host = location.hostname || "";
  // GitHub Pages User/Org: <owner>.github.io  -> Repo <owner>.github.io, Branch main (Heuristik)
  if(/^[\w-]+\.github\.io$/i.test(host)){
    const owner = host.split(".")[0];
    const repo  = owner + ".github.io";
    const branch = "main";
    return `https://github.com/${owner}/${repo}/blob/${branch}/${encodeURI(clean)}`;
  }
  // Fallback: direkte Seiten-URL
  return `${location.origin}/${encodeURI(clean)}`;
}

function convertLatexDelimiters(src){
  let out="", i=0, inFence=false, inInline=false; const starts=s=>src.startsWith(s,i);
  while(i<src.length){
    if(!inInline&&starts("```")){inFence=!inFence; out+="```"; i+=3; continue;}
    if(!inFence&&src[i]==="`"){inInline=!inInline; out+=src[i++]; continue;}
    if(!inFence&&!inInline){
      if(starts("\\(")){out+="$"; i+=2; continue;}
      if(starts("\\)")){out+="$"; i+=2; continue;}
      if(starts("\\[")){out+="$$"; i+=2; continue;}
      if(starts("\\]")){out+="$$"; i+=2; continue;}
    }
    out+=src[i++];
  }
  return out;
}

function setRunPyVisible(show){const btn=document.getElementById("btnRunPy"); btn.style.display=show?"inline-block":"none"; if(!show) btn.onclick=null;}
function wireCopyLink(){
  const btn=document.getElementById("btnCopyLink");
  if(!btn) return;
  btn.onclick = async ()=>{
    if(!currentShareUrl) return;
    try{
      await navigator.clipboard.writeText(currentShareUrl);
      const old = btn.textContent;
      btn.textContent = I18n.t("viewer.copied","Kopiert!");
      setTimeout(()=>{ btn.textContent = I18n.t("viewer.copyLink","Link kopieren"); }, 1200);
    }catch{
      // Fallback: neues Tab
      window.open(currentShareUrl, "_blank");
    }
  };
}

function normalizeEntries(raw){
  const out=[]; const take=e=>{let p=e.path||e.file||null; if(!p) return; p=p.replace(/^\/+/,""); let t=e.type; if(t==="blob") t="file"; if(t==="tree") t="dir"; if(!t) t="file"; const n={path:p,name:baseName(p),type:(t==="dir"?"dir":"file")}; if(typeof e.size==="number")n.size=e.size; out.push(n);};
  if(Array.isArray(raw)) raw.forEach(take);
  else if(raw&&typeof raw==="object"){
    if(Array.isArray(raw.entries)) raw.entries.forEach(take);
    else if(Array.isArray(raw.tree)) raw.tree.forEach(take);
    else if(Array.isArray(raw.items)) raw.items.forEach(take);
  }
  return out;
}
function indexEntries(nodes){
  NODES.clear(); CHILDREN.clear();
  for(const n of nodes) NODES.set(n.path,n);
  for(const n of nodes){
    const parts=n.path.split("/").slice(0,-1); let acc="";
    for(const seg of parts){ acc=acc?acc+"/"+seg:seg; if(!NODES.has(acc)) NODES.set(acc,{path:acc,name:seg,type:"dir"}); }
  }
  for(const n of NODES.values()){
    const parent=pathDir(n.path);
    if(!CHILDREN.has(parent)) CHILDREN.set(parent,[]);
    CHILDREN.get(parent).push(n);
  }
  for(const [k,arr] of CHILDREN){arr.sort((a,b)=> (a.type!==b.type)?(a.type==="dir"?-1:1):a.name.localeCompare(b.name,undefined,{numeric:true}));}
}

function crumbHtml(path){const parts=path?path.split("/").filter(Boolean):[]; const items=['<a href="#" data-path="">/</a>']; let acc=""; for(const p of parts){acc=acc?acc+"/"+p:p; items.push(`<a href="#" data-path="${acc}">${p}</a>`);} return items.join(" / ");}
function renderCrumb(){const el=document.getElementById("crumb"); el.innerHTML=crumbHtml(cwd); el.querySelectorAll("a").forEach(a=>a.addEventListener("click",e=>{e.preventDefault(); openDir(a.dataset.path||"");}));}
function renderList(){
  const q=(document.getElementById("q").value||"").trim().toLowerCase(); const list=document.getElementById("list"); list.innerHTML="";
  if(cwd){const up=document.createElement("li"); up.className="item"; up.innerHTML=`<span class="meta">⬆️</span><span class="name" data-i18n="viewer.up">.. (Ebene höher)</span><span class="meta">UP</span>`; up.addEventListener("click",()=>openDir(pathDir(cwd))); list.appendChild(up); I18n.apply();}
  const children=(CHILDREN.get(cwd)||[]).filter(e=>!q||e.name.toLowerCase().includes(q));
  if(!children.length){const li=document.createElement("li"); li.className="item"; li.innerHTML=`<span class="meta">—</span><span class="name" data-i18n="browser.empty">Keine Dateien gefunden.</span><span class="meta"></span>`; list.appendChild(li); I18n.apply(); return;}
  for(const e of children){
    const li=document.createElement("li"); li.className="item"; li.dataset.path=e.path;
    const icon=e.type==="dir"?"📁":"📄"; const extension=e.type==="dir"?"DIR":(ext(e.name).toUpperCase()||"FILE"); const size=e.type==="dir"?"":fmtSize(e.size);
    li.innerHTML=`<span class="meta">${icon}</span><span class="name">${e.name}</span><span class="meta">${extension}${size?" • "+size:""}</span>`;
    li.addEventListener("click",()=>{document.querySelectorAll(".item.active").forEach(n=>n.classList.remove("active")); li.classList.add("active"); if(e.type==="dir") openDir(e.path); else openFile(e.path);});
    list.appendChild(li);
  }
}
async function openDir(path=""){cwd=path; renderCrumb(); renderList();}

function updateManifestChip(loading=false){
  const dot=document.getElementById("manifestDot"), txt=document.getElementById("manifestText");
  if(loading){dot.className="dot"; txt.textContent=I18n.lang==="en"?"Indexing…":"Indiziere…"; return;}
  try{
    const files=[...NODES.values()].filter(n=>n.type==="file").length;
    const dirs=[...NODES.values()].filter(n=>n.type==="dir").length;
    const t=MANIFEST?.indexedAt||MANIFEST?.generatedAt||MANIFEST?.timestamp||null;
    const d=t?new Date(t):new Date(lastManifestTs||Date.now());
    const locale=(I18n&&I18n.lang==="en")?"en-GB":"de-DE";
    const stamp=d.toLocaleString(locale,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    txt.textContent=`${files} ${I18n.t("status.files","Dateien")} • ${dirs} ${I18n.t("status.folders","Ordner")} • ${I18n.t("status.indexedAt","Stand")}: ${stamp}`;
    dot.className="dot ok";
  }catch{document.getElementById("manifestDot").className="dot err"; txt.textContent=I18n.t("status.manifestInvalid","Manifest ungültig");}
}

async function loadManifest(){
  try{
    updateManifestChip(true);
    const ts=Date.now();
    const m=await fetchJSON(`manifest.json?ts=${ts}`);
    MANIFEST=m; lastManifestTs=ts;
    const norm=normalizeEntries(m); if(!norm.length) throw new Error("manifest.json enthält keine Einträge.");
    indexEntries(norm); updateManifestChip(false); return true;
  }catch(e){
    console.error("manifest.json laden fehlgeschlagen:", e);
    MANIFEST={}; NODES.clear(); CHILDREN.clear(); NODES.set("",{path:"",name:"",type:"dir"}); CHILDREN.set("",[]);
    const list=document.getElementById("list");
    if(list) list.innerHTML=`<li class="item"><span class="meta">⚠️</span><span class="name">manifest.json konnte nicht geladen werden. Über HTTPS/Pages oder lokalen Server öffnen.</span><span class="meta"></span></li>`;
    updateManifestChip(false); return false;
  }
}

function renderFooter(){
  const y=new Date().getFullYear();
  document.getElementById("copyright").textContent =
    I18n.lang==="en"
      ? `© ${y} antaris — Code: MIT; Data/Figures/Texts (incl. PDFs): CC BY 4.0.`
      : `© ${y} antaris — Code: MIT; Daten/Abbildungen/Texte (inkl. PDFs): CC BY 4.0.`;
}

/* ===================== Viewer ===================== */
function showMd(html,titleText){
  const md=document.getElementById("md"), gen=document.getElementById("generic");
  setRunPyVisible(false); gen.hidden=true; gen.innerHTML=""; md.hidden=false; md.innerHTML=html;
  document.getElementById("currentName").textContent=titleText||"—";
  document.querySelectorAll("#md pre code").forEach(b=>hljs.highlightElement(b));
  try{
    renderMathInElement(md,{ delimiters:[
      {left:"$$", right:"$$", display:true},
      {left:"\\[", right:"\\]", display:true},
      {left:"\\(", right:"\\)", display:false},
      {left:"$", right:"$", display:false}
    ], throwOnError:false });
  }catch{}
  wireCopyLink();
}
function showGeneric(node,titleText){
  const md=document.getElementById("md"), gen=document.getElementById("generic");
  md.hidden=true; md.innerHTML=""; gen.hidden=false; gen.innerHTML=""; gen.appendChild(node);
  document.getElementById("currentName").textContent=titleText||"—";
  wireCopyLink();
}
function existsInManifest(path){return NODES.has((path||"").replace(/^\/+/,""));}

async function openMarkdown(path){
  lastMdBasePath = path.replace(/\.en\.md$/i, ".md").replace(/\.de\.md$/i, ".md");
  const lang = I18n.lang || ""; let chosen = path.toLowerCase();
  if(lang==="en"){
    if(chosen.endsWith(".md")&&!chosen.endsWith(".en.md")){const cand=path.replace(/\.md$/i,".en.md"); if(existsInManifest(cand)) path=cand;}
    if(chosen.endsWith(".de.md")){const cand=path.replace(/\.de\.md$/i,".en.md"); if(existsInManifest(cand)) path=cand;}
  }
  currentRawUrl = urlFor(path);
  currentShareUrl = computeShareLink(path);
  document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
  document.getElementById("btnPdf").onclick=()=>window.print();
  wireCopyLink();
  try{
    let text = await fetchText(currentRawUrl);
    text = convertLatexDelimiters(text);
    marked.setOptions({gfm:true, breaks:false});
    const html = DOMPurify.sanitize(marked.parse(text));
    showMd(html, path.split("/").pop());
    document.querySelector(".right").scrollTop=0;
  }catch(e){
    const p=document.createElement("p"); p.style.color="#ff8080"; p.textContent=`${I18n.t("errors.loadFailed","Datei konnte nicht geladen werden")}: ${e.message}`;
    showGeneric(p, path.split("/").pop());
  }
}

async function openCsv(path){
  setRunPyVisible(false);
  currentRawUrl = urlFor(path);
  currentShareUrl = computeShareLink(path);
  document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
  document.getElementById("btnPdf").onclick=()=>window.print();
  wireCopyLink();
  const wrap=document.createElement("div");
  try{
    const text=await fetchText(currentRawUrl); const parsed=Papa.parse(text.trim());
    const table=document.createElement("table"); table.className="md";
    parsed.data.forEach((row,i)=>{const tr=document.createElement("tr"); row.forEach(cell=>{const td=document.createElement(i===0?"th":"td"); td.textContent=cell; tr.appendChild(td)}); table.appendChild(tr);});
    wrap.appendChild(table);
  }catch(e){const p=document.createElement("p"); p.style.color="#ff8080"; p.textContent=`${I18n.t("errors.loadFailed","Datei konnte nicht geladen werden")}: ${e.message}`; wrap.appendChild(p);}
  showGeneric(wrap, path.split("/").pop());
}
async function openPdf(path){
  setRunPyVisible(false);
  currentRawUrl = urlFor(path);
  currentShareUrl = computeShareLink(path);
  document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
  document.getElementById("btnPdf").onclick=()=>window.print();
  wireCopyLink();

  if(typeof window.pdfjsLib==="undefined"){
    const frame=document.createElement("iframe"); frame.className="preview"; frame.src=currentRawUrl; frame.title=path.split("/").pop(); frame.style.height="78vh";
    showGeneric(frame, path.split("/").pop()); return;
  }
  const container=document.createElement("div"); container.className="preview";
  container.style.padding="16px"; container.style.background="#0f1922"; container.style.borderRadius="10px";
  container.style.maxWidth="980px"; container.style.margin="0 auto";
  try{
    const data=await fetchArrayBuffer(currentRawUrl);
    const pdf=await pdfjsLib.getDocument({ data }).promise;
    for(let n=1;n<=pdf.numPages;n++){
      const page=await pdf.getPage(n), viewport=page.getViewport({ scale:1.5 });
      const canvas=document.createElement("canvas"), ctx=canvas.getContext("2d");
      canvas.width=viewport.width; canvas.height=viewport.height; canvas.style.display="block"; canvas.style.margin="0 auto 12px";
      await page.render({ canvasContext:ctx, viewport }).promise;
      container.appendChild(canvas);
    }
    showGeneric(container, path.split("/").pop());
  }catch(e){
    const frame=document.createElement("iframe"); frame.className="preview"; frame.src=currentRawUrl; frame.title=path.split("/").pop(); frame.style.height="78vh";
    showGeneric(frame, path.split("/").pop());
  }
}
function openImage(path){
  setRunPyVisible(false);
  currentRawUrl = urlFor(path);
  currentShareUrl = computeShareLink(path);
  document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
  document.getElementById("btnPdf").onclick=()=>window.print();
  wireCopyLink();
  const img=document.createElement("img"); img.className="preview"; img.src=currentRawUrl; img.alt=path.split("/").pop();
  showGeneric(img, img.alt);
}
function openAudio(path){
  setRunPyVisible(false);
  currentRawUrl = urlFor(path);
  currentShareUrl = computeShareLink(path);
  document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
  document.getElementById("btnPdf").onclick=()=>window.print();
  wireCopyLink();
  const audio=document.createElement("audio"); audio.className="preview"; audio.controls=true; audio.src=currentRawUrl;
  showGeneric(audio, path.split("/").pop());
}
function openVideo(path){
  setRunPyVisible(false);
  currentRawUrl = urlFor(path);
  currentShareUrl = computeShareLink(path);
  document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
  document.getElementById("btnPdf").onclick=()=>window.print();
  wireCopyLink();
  const video=document.createElement("video"); video.className="preview"; video.controls=true; video.src=currentRawUrl;
  showGeneric(video, path.split("/").pop());
}
function openRawFile(path){
  setRunPyVisible(false);
  currentRawUrl = urlFor(path);
  currentShareUrl = computeShareLink(path);
  document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
  document.getElementById("btnPdf").onclick=()=>window.print();
  wireCopyLink();
  const frame=document.createElement("iframe"); frame.className="preview"; frame.src=currentRawUrl; frame.title=path.split("/").pop(); frame.style.height="78vh";
  showGeneric(frame, path.split("/").pop());
}
function openFile(path){
  const e=ext(path);
  if(e==="md"||e==="markdown"||e==="mdown") return openMarkdown(path);
  if(isPdfExt(e)) return openPdf(path);
  if(isImageExt(e)) return openImage(path);
  if(isAudioExt(e)) return openAudio(path);
  if(isVideoExt(e)) return openVideo(path);
  if(e==="csv"||e==="tsv") return openCsv(path);
  if(isTextExt(e)) return openText(path);
  return openRawFile(path);
}

/* ===================== Pyodide + Python Runner ===================== */
let __pyodidePromise=null, __pyInstance=null, __downloadedThisRun=new Set();

async function loadPyodideOnce(){
  if(!__pyodidePromise){
    __pyodidePromise = loadPyodide({
      indexURL:"https://cdn.jsdelivr.net/pyodide/v0.25.1/full/"
    }).then(py=>{ __pyInstance=py; return py; });
  }
  return __pyodidePromise;
}
function detectPyodidePkgsFromCode(code){
  const s=new Set(), has=re=>re.test(code);
  if(has(/\bimport\s+pandas\b|\bfrom\s+pandas\s+import\b/)) s.add("pandas");
  if(has(/\bimport\s+numpy\b|\bfrom\s+numpy\s+import\b/)) s.add("numpy");
  if(has(/\bimport\s+matplotlib\b|\bfrom\s+matplotlib\s+import\b/)) s.add("matplotlib");
  if(has(/\bimport\s+scipy\b|\bfrom\s+scipy\s+import\b/)) s.add("scipy");
  if(has(/\bimport\s+sympy\b|\bfrom\s+sympy\s+import\b/)) s.add("sympy");
  if(has(/\bimport\s+networkx\b|\bfrom\s+networkx\s+import\b/)) s.add("networkx");
  if(has(/\bimport\s+PIL\b|\bfrom\s+PIL\s+import\b/)) s.add("pillow");
  if(has(/\bimport\s+imageio\b|\bfrom\s+imageio\s+import\b/)) s.add("imageio");
  return Array.from(s);
}
function detectMatplotlibBackend(code){
  if(/\bbackend\s*:\s*html5\b/i.test(code)) return "module://matplotlib_pyodide.html5_canvas_backend";
  return "module://matplotlib.backends.backend_agg";
}
async function ensurePyPackages(explicit=[], code=""){
  const py=await loadPyodideOnce();
  const base=["micropip","numpy","matplotlib","pillow"];
  const detected=detectPyodidePkgsFromCode(code);
  const toLoad=Array.from(new Set([...base, ...explicit, ...detected]));
  if(toLoad.length) await py.loadPackage(toLoad);
  return py;
}

/* ---- Import-Parser für lokale Module ---- */
function extractImportNames(code){
  const names=new Set();
  for(const m of code.matchAll(/^[ \t]*import\s+([^\n#;]+)/gm)){
    const list=m[1].split(","); for(let part of list){
      part=part.trim(); if(!part) continue;
      part=part.replace(/\s+as\s+.*$/,"");
      const top=part.split(".")[0].trim(); if(top) names.add(top);
    }
  }
  for(const m of code.matchAll(/^[ \t]*from\s+([.\w]+)\s+import\s+([^\n#;]+)/gm)){
    let mod=m[1].trim(); mod=mod.replace(/^\.+/,"");
    if(!mod) continue;
    const top=mod.split(".")[0].trim(); if(top) names.add(top);
  }
  const common=["os","sys","re","math","itertools","json","pathlib","typing","collections","time","datetime","random","functools","subprocess"];
  common.forEach(n=>names.delete(n));
  return Array.from(names);
}

/* ---- Helper: Direktes Nachladen in /repo ---- */
async function tryFetchToRepo(py, relPath, destRel) {
  try {
    const txt = await fetchText(urlFor(relPath));   // cache: no-store
    const dest = `/repo/${destRel}`;
    const dir  = dest.split("/").slice(0, -1).join("/");
    try { py.FS.mkdirTree(dir); } catch {}
    py.FS.writeFile(dest, new TextEncoder().encode(txt));
    return dest;
  } catch {
    return null;
  }
}

/* ---- Paket-Rebase priorisiert Skriptordner & Parent ---- */
async function rebaseModuleToRepo(py, modName, contextPath){
  const modLower   = (modName||"").toLowerCase();
  const pkgRoot    = `/repo/${modLower}`;
  const written    = [];
  let   hasInit    = false;

  const norm = p => (p||"").replace(/^\/+/,"");
  const scriptRel  = norm(pathDir(contextPath||""));
  const parentRel  = norm(pathDir(scriptRel));

  // 1) Paket-Root relativ zum Skript suchen: <script>/<mod>/__init__.py, dann ../<mod>/__init__.py
  const relPkgCandidates = [
    (scriptRel ? `${scriptRel}/${modLower}/__init__.py` : `${modLower}/__init__.py`),
    (parentRel ? `${parentRel}/${modLower}/__init__.py` : `../${modLower}/__init__.py`)
  ];
  for (const rel of relPkgCandidates){
    const ok = await tryFetchToRepo(py, rel, `${modLower}/__init__.py`);
    if (ok){ written.push(ok); hasInit = true; break; }
  }

  // 2) Wenn Paket-Root gefunden → restlichen Baum über Manifest kopieren (unterhalb scriptRel + parentRel)
  async function copyTreeFromManifest(rootBaseRel){
    const root = norm(rootBaseRel);
    const prefix = (root ? `${root}/${modLower}/` : `${modLower}/`).toLowerCase();
    for (const n of NODES.values()){
      if (n.type !== "file") continue;
      const pLower = norm(n.path).toLowerCase();
      if (pLower.startsWith(prefix)){
        const tail = n.path.slice((root ? (root + "/") : "").length + (modLower.length + 1)); // hinter "<root>/<mod>/"
        const dest = `${pkgRoot}/${tail}`;
        try{
          const txt = await fetchText(urlFor(n.path));
          const dir = dest.split("/").slice(0,-1).join("/");
          try{ py.FS.mkdirTree(dir); }catch{}
          py.FS.writeFile(dest, new TextEncoder().encode(txt));
          written.push(dest);
          if (tail === "__init__.py") hasInit = true;
        }catch{}
      }
    }
  }
  if (written.length){
    if (scriptRel) await copyTreeFromManifest(scriptRel);
    if (parentRel) await copyTreeFromManifest(parentRel);
  }

  // 3) Falls noch nichts: relative Einzelmodul-Datei prüfen (<script>/<mod>.py, ../<mod>.py)
  if (written.length === 0){
    const relFileCandidates = [
      (scriptRel ? `${scriptRel}/${modLower}.py` : `${modLower}.py`),
      (parentRel ? `${parentRel}/${modLower}.py` : `../${modLower}.py`)
    ];
    for (const rel of relFileCandidates){
      const ok = await tryFetchToRepo(py, rel, `${modLower}.py`);
      if (ok){ written.push(ok); break; }
    }
  }

  // 4) Wenn immer noch nichts: global über Manifest (ganzer Baum irgendwo)
  if (written.length === 0){
    for (const n of NODES.values()){
      if (n.type !== "file") continue;
      const pLower = n.path.toLowerCase();
      const parts  = pLower.split("/");
      const idx    = parts.indexOf(modLower);
      if (idx >= 0){
        const tail = n.path.split("/").slice(idx+1).join("/");
        const dest = `${pkgRoot}/${tail}`;
        try{
          const txt = await fetchText(urlFor(n.path));
          const dir = dest.split("/").slice(0,-1).join("/");
          try{ py.FS.mkdirTree(dir);}catch{}
          py.FS.writeFile(dest, new TextEncoder().encode(txt));
          written.push(dest);
          if (tail === "__init__.py") hasInit = true;
        }catch{}
      }
    }
  }

  // 5) Letzter Fallback: harte Pfade
  if (written.length === 0){
    const pkgCandidates = [
      `assets/${modLower}/__init__.py`,
      `assets/python/${modLower}/__init__.py`,
      `python/${modLower}/__init__.py`,
      `py/${modLower}/__init__.py`,
      `lib/${modLower}/__init__.py`,
      `scripts/${modLower}/__init__.py`,
      `src/${modLower}/__init__.py`,
      `${modLower}/__init__.py`
    ];
    for (const rel of pkgCandidates){
      const ok = await tryFetchToRepo(py, rel, `${modLower}/__init__.py`);
      if (ok){ written.push(ok); hasInit = true; break; }
    }
  }

  // 6) Namespace-Package ohne __init__ absichern
  if (written.length > 0 && !hasInit) {
    const dest = `${pkgRoot}/__init__.py`;
    try {
      try { py.FS.mkdirTree(pkgRoot); } catch {}
      py.FS.writeFile(dest, new TextEncoder().encode(""));
      written.push(dest);
      hasInit = true;
    } catch {}
  }

  return written;
}

/* ---- Auto-Download erzeugter Dateien ---- */
function resolveFsPath(p){return p&&p.startsWith("/")?p:`/home/pyodide/${p||""}`;}
function guessMimeByExt(path){
  const e=(path.split(".").pop()||"").toLowerCase();
  if(["png"].includes(e))return"image/png";
  if(["jpg","jpeg"].includes(e))return"image/jpeg";
  if(["gif"].includes(e))return"image/gif";
  if(["webp"].includes(e))return"image/webp";
  if(["svg"].includes(e))return"image/svg+xml";
  if(["pdf"].includes(e))return"application/pdf";
  if(["txt","log","md","csv","tsv","json","xml","yml","yaml"].includes(e))return"text/plain";
  return"application/octet-stream";
}
function downloadPath(py, path){
  const abs=resolveFsPath(path);
  try{
    const data=py.FS.readFile(abs);
    const blob=new Blob([data],{type:guessMimeByExt(abs)});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob); a.download=abs.split("/").pop();
    document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();}, 1000);
    return true;
  }catch{ return false; }
}
function walkFs(py, dir="/home/pyodide", acc=[]){
  let list; try{list=py.FS.readdir(dir);}catch{return acc;}
  for(const name of list){
    if(name==="."||name==="..") continue;
    const p=dir.endsWith("/")?dir+name:dir+"/"+name;
    let st; try{st=py.FS.stat(p);}catch{continue;}
    const isDir = py.FS.isDir ? py.FS.isDir(st.mode) : (st.mode & 0x4000)===0x4000;
    if(isDir) walkFs(py,p,acc); else acc.push({path:p,size:st.size??0,mtime:+new Date(st.mtime||0)});
  }
  return acc;
}
function snapshotFs(py){const m=new Map(); for(const f of walkFs(py,"/home/pyodide")) m.set(f.path,{size:f.size,mtime:f.mtime}); return m;}
function diffFs(prev,curr){const out=[]; for(const [p,meta] of curr.entries()){const old=prev.get(p); if(!old||old.size!==meta.size||old.mtime!==meta.mtime) out.push(p);} return out;}
function appendStdout(outEl, chunk){
  const lines=String(chunk).split(/\r?\n/);
  for(const line of lines){
    if(!line) continue;
    if(/^DATA:image\//i.test(line)){
      const img=document.createElement("img"); img.src=line.trim(); img.style.display="block"; img.style.maxWidth="980px"; img.style.margin="8px auto"; img.className="preview";
      outEl.appendChild(img); continue;
    }
    const m=line.match(/^WROTE:\s*(.+)$/i);
    if(m&&__pyInstance){
      const p=m[1].trim();
      if(!__downloadedThisRun.has(p)){ if(downloadPath(__pyInstance,p)) __downloadedThisRun.add(p); }
      continue;
    }
    outEl.append(document.createTextNode(line+"\n"));
  }
}

/* ---- Run Python (mit Modul-Preload & Skriptordner-Priorität) ---- */
async function runPythonWithProject(code, outEl, buttonEl, contextPath){
  const btn=buttonEl;
  try{
    if(btn){btn.disabled=true; btn.textContent=(I18n?.lang==="en"?"Running…":"Läuft…");}
    outEl.textContent=""; __downloadedThisRun=new Set();

    const py=await ensurePyPackages([], code);

    // Lokale Module bestimmen & rebasen (mit Kontextpfad)
    const importNames = extractImportNames(code);
    const rebased = [];
    for(const name of importNames){
      const got = await rebaseModuleToRepo(py, name, contextPath);
      if(got.length) rebased.push(`${name}(${got.length})`);
    }

    // sys.path Priorität: /repo/<skriptordner>, /repo/<skript_parent>, /repo, /home/pyodide
    const scriptRel = pathDir(contextPath||"");
    const parentRel = pathDir(scriptRel);

    const backend = detectMatplotlibBackend(code);
    const prelude = `
import os, sys, matplotlib, importlib
for p in [
    "${("/repo/"+scriptRel).replace(/\/$/,"")}",
    "${("/repo/"+parentRel).replace(/\/$/,"")}",
    "/repo",
    "/home/pyodide"
]:
    if p and p not in sys.path:
        sys.path.insert(0, p)
importlib.invalidate_caches()
os.environ["MPLBACKEND"] = "${backend}"
try:
    matplotlib.use("${backend}", force=True)
except Exception:
    import importlib as _il
    if "matplotlib.pyplot" in sys.modules:
        try:
            import matplotlib.pyplot as _plt
            _plt.close("all")
        except Exception: pass
        del sys.modules["matplotlib.pyplot"]
    _il.reload(matplotlib)
    matplotlib.use("${backend}", force=True)
`;

    if(rebased.length){
      outEl.append(document.createTextNode((I18n?.lang==="en"?"Loaded local modules: ":"Geladene lokale Module: ")+rebased.join(", ")+"\n"));
    }

    const before=snapshotFs(py);
    py.setStdout({batched:s=>appendStdout(outEl,s)}); py.setStderr({batched:s=>appendStdout(outEl,s)});
    await py.runPythonAsync(prelude + "\n" + code);

    const after=snapshotFs(py); const changed=diffFs(before,after);
    const remaining=changed.filter(p=>!__downloadedThisRun.has(p));
    if(remaining.length) outEl.append(document.createTextNode((I18n?.lang==="en"?"Auto-download: ":"Automatischer Download: ")+remaining.length+" file(s)\n"));
    for(const p of remaining) downloadPath(__pyInstance,p);

  }catch(err){
    appendStdout(outEl,"\n"+err);
  }finally{
    if(btn){btn.disabled=false; btn.textContent=(I18n?.lang==="en"?"Run Python":"Python ausführen");}
  }
}

/* ---- Code/Text öffnen (mit Python bei .py) ---- */
async function openText(path){
  currentRawUrl = urlFor(path);
  currentShareUrl = computeShareLink(path);
  const btnRun=document.getElementById("btnRunPy");
  document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
  document.getElementById("btnPdf").onclick=()=>window.print();
  wireCopyLink();

  const pre=document.createElement("pre"); pre.className="codebox";
  const codeEl=document.createElement("code"); pre.appendChild(codeEl);
  const out=document.createElement("pre"); out.className="codebox"; out.style.marginTop="12px"; out.title="stdout / stderr";

  try{
    const text=await fetchText(currentRawUrl);
    codeEl.textContent=text;
    const language=ext(path); if(language) codeEl.className=`language-${language}`;
    hljs.highlightElement(codeEl);
  }catch(e){ codeEl.textContent=`${I18n.t("errors.loadFailed","Datei konnte nicht geladen werden")}: ${e.message}`; }

  const wrap=document.createElement("div"); wrap.appendChild(pre);

  if(ext(path)==="py"){
    setRunPyVisible(true);
    btnRun.onclick = ()=> runPythonWithProject(codeEl.textContent, out, btnRun, path);
    const hint=document.createElement("div"); hint.className="muted"; hint.style.margin="6px 0 2px";
    hint.innerHTML = I18n?.lang==="en"
      ? `Local imports are mirrored from the script's folder (and its parent) into <code>/repo</code>. Default Matplotlib backend: <code>Agg</code>. Switch to HTML5 with <code># backend: html5</code> in the first line. Files created during the run will be auto-downloaded.`
      : `Lokale Imports werden zuerst relativ zum Skriptordner (und dessen Elternordner) nach <code>/repo</code> gespiegelt. Standard-Matplotlib-Backend: <code>Agg</code>. Zu HTML5 mit <code># backend: html5</code> in der ersten Zeile wechseln. Erzeugte Dateien werden automatisch heruntergeladen.`;
    wrap.appendChild(hint);
    wrap.appendChild(out);
  } else {
    setRunPyVisible(false);
  }
  showGeneric(wrap, path.split("/").pop());
}

/* ---- Initial: im gewünschten Startordner öffnen & ST.png dort anzeigen ---- */
function openInitialPreview(){
  const candidate = (cwd ? (cwd.replace(/\/+$/,"") + "/") : "") + "ST.png";
  if(existsInManifest(candidate)){
    const item=[...document.querySelectorAll("#list .item")].find(li=>li.dataset.path===candidate);
    if(item){document.querySelectorAll("#list .item.active").forEach(n=>n.classList.remove("active")); item.classList.add("active");}
    openImage(candidate);
  }
}

/* ---- Events ---- */
document.getElementById("q").addEventListener("input",renderList);
document.getElementById("langSelect").addEventListener("change", async (e)=>{
  await I18n.set(e.target.value); renderFooter(); updateManifestChip(); if(lastMdBasePath) openMarkdown(lastMdBasePath);
});
document.getElementById("btnRefresh").addEventListener("click", async ()=>{
  await loadManifest(); await openDir(cwd || ""); openInitialPreview();
});
window.addEventListener("pageshow", async ()=>{
  if(location.protocol!=="file:"){ await loadManifest(); await openDir(cwd || ""); }
});
document.addEventListener("DOMContentLoaded", async ()=>{
  if(location.protocol==="file:"){
    const list=document.getElementById("list");
    if(list) list.innerHTML = `<li class="item"><span class="meta">ℹ️</span><span class="name">Bitte via lokalen Server (z. B. <code>python -m http.server</code>) oder GitHub Pages öffnen. <code>file://</code> blockiert <code>fetch</code>.</span><span class="meta"></span></li>`;
    return;
  }
  await I18n.init({ defaultLang:"de" });
  renderFooter();
  await loadManifest();
  // Start im gewünschten Ordner, falls vorhanden
  if (existsInManifest(START_PATH)) {
    await openDir(START_PATH);
  } else {
    await openDir("");
  }
  openInitialPreview();
  wireCopyLink();
});
</script>
</body>
</html>
