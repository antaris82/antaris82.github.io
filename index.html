<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sierpinski Project</title>
  <style>
    :root {
      --bg: #0b1117;
      --panel: #0e141b;
      --muted: #8aa0b4;
      --fg: #e7eef5;
      --accent: #5ba8ff;
      --border: #1b2632;
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    header {
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 16px; background: var(--panel); border-bottom:1px solid var(--border);
      position: sticky; top:0; z-index:5;
    }
    .title { display:flex; gap:12px; align-items: baseline; }
    .title h1 { margin:0; font-size: 18px; }
    .title span { color: var(--muted); font-size: 13px; }

    .lang { display:flex; align-items:center; gap:8px; }
    .lang label { color: var(--muted); }
    .lang select {
      background:#0e141b; color:var(--fg);
      border:1px solid #26303c; border-radius:8px; padding:6px 10px;
    }

    .app { display:grid; grid-template-columns: 320px 1fr; height: calc(100vh - 56px); }
    .left {
      border-right: 1px solid var(--border); background: #0c1218; overflow:auto;
    }
    .right { overflow:auto; }

    .left .section { padding: 12px 14px; border-bottom: 1px solid var(--border); }
    .section h2 { margin:0 0 8px; font-size:13px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }

    .search { padding: 0 14px 12px; border-bottom: 1px solid var(--border); }
    .search input {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #24303c;
      background:#0f1720; color:var(--fg);
    }

    .list { list-style: none; margin:0; padding:6px; }
    .item {
      display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:8px; cursor:pointer;
      color: #fff; /* Ordner/Datei-Schrift stets wei√ü */
    }
    .item:hover { background:#111a23; }
    .item .name { flex:1 1 auto; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .item .kind { color: var(--muted); font-size:12px; }
    .item.active { background:#122236; }

    .viewer {
      padding: 18px 22px 60px;
    }
    .viewer .bar {
      display:flex; align-items:center; gap:8px; justify-content: space-between;
      position: sticky; top:0; padding: 10px 0; background: linear-gradient(var(--bg), var(--bg));
    }
    .viewer .btns { display:flex; gap:8px; }
    .btn {
      background:#0f1922; border:1px solid #26303c; color: var(--fg);
      padding:8px 10px; border-radius:8px; cursor:pointer;
    }
    .btn:hover { background:#122436; }
    .muted { color: var(--muted); }

    .md { max-width: 920px; }
    .md h1, .md h2, .md h3, .md h4 { margin-top: 1.6em; }
    .md pre { background:#0f1922; padding:12px; border-radius:10px; overflow:auto; border:1px solid #223042; }
    .md code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .md table { border-collapse: collapse; border:1px solid #223042; }
    .md table th, .md table td { border:1px solid #223042; padding:6px 8px; }
    .md img { max-width: 100%; }

    /* Print for PDF export */
    @media print {
      header, .left, .viewer .bar { display:none !important; }
      .app { display:block; }
      body { background:#fff; color:#000; }
      .md pre { border:1px solid #ccc; background:#fafafa; }
    }
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

  <!-- i18n runtime -->
  <script src="assets/i18n.js"></script>
</head>
<body>
  <header>
    <div class="title">
      <h1 data-i18n="app.title">Sierpinski-Tetraeder ‚Äì Projekt</h1>
      <span class="muted" data-i18n="app.subtitle">Experiment, Dokumentation und Materialien</span>
    </div>
    <div class="lang">
      <label for="langSelect" data-i18n="app.language">Sprache</label>
      <select id="langSelect" aria-label="Language">
        <option value="de">Deutsch</option>
        <option value="en">English</option>
      </select>
    </div>
  </header>

  <main class="app">
    <!-- Browser -->
    <aside class="left">
      <div class="section"><h2 data-i18n="browser.title">Dateibrowser</h2></div>
      <div class="search">
        <input id="q" type="search" placeholder="Suchen ‚Ä¶"
               data-i18n="search" data-i18n-attr="placeholder" data-i18n-search="search.placeholder">
      </div>
      <ul id="list" class="list"></ul>
    </aside>

    <!-- Viewer -->
    <section class="right">
      <div class="viewer">
        <div class="bar">
          <div class="muted" id="crumb">/</div>
          <div class="btns">
            <button id="btnOpenRaw" class="btn" data-i18n="viewer.openRaw">Rohdatei √∂ffnen</button>
            <button id="btnPdf" class="btn" data-i18n="viewer.downloadPdf">Als PDF exportieren</button>
          </div>
        </div>
        <article id="md" class="md"></article>
      </div>
    </section>
  </main>

  <script>
    // ------- Config (Repo/Branch) -------
    const GH = { owner: "antaris82", repo: "antaris82.github.io", branch: "main" };

    // ------- State -------
    let cwd = "";                  // current directory path
    let entries = [];              // current directory listing
    let currentFilePath = null;    // currently viewed file (in repo)
    let currentRawUrl = null;

    // ------- Helpers -------
    const api = (p="") =>
      `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${p ? p.replace(/^\/+/,'') : ""}?ref=${GH.branch}`;
    const raw = (p="") =>
      `https://raw.githubusercontent.com/${GH.owner}/${GH.repo}/${GH.branch}/${p.replace(/^\/+/,'')}`;

    async function fetchJSON(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    function sortEntries(items){
      const dirs = items.filter(e => e.type === "dir");
      const files = items.filter(e => e.type === "file");
      dirs.sort((a,b)=> a.name.localeCompare(b.name, undefined, {numeric:true}));
      files.sort((a,b)=> a.name.localeCompare(b.name, undefined, {numeric:true}));
      return [...dirs, ...files];
    }

    function renderList(items){
      const q = (document.getElementById("q").value || "").trim().toLowerCase();
      const list = document.getElementById("list");
      list.innerHTML = "";
      const filtered = items.filter(e => !q || e.name.toLowerCase().includes(q));
      if (!filtered.length){
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `<span class="name" data-i18n="browser.empty">Keine Dateien gefunden.</span>`;
        list.appendChild(li);
        I18n.apply();
        return;
      }
      for (const e of filtered){
        const li = document.createElement("li");
        li.className = "item";
        li.dataset.path = e.path;

        const icon = e.type === "dir" ? "üìÅ" : "üìÑ";
        const kind = e.type === "dir" ? "dir" : (e.name.toLowerCase().endsWith(".md") ? "md" : "file");

        li.innerHTML = `
          <span class="kind">${icon}</span>
          <span class="name">${e.name}</span>
          <span class="kind">${kind}</span>
        `;

        li.addEventListener("click", () => {
          document.querySelectorAll(".item.active").forEach(n => n.classList.remove("active"));
          li.classList.add("active");
          if (e.type === "dir") {
            openDir(e.path);
          } else {
            // markdown opens in viewer, other files open raw
            if (e.name.toLowerCase().endsWith(".md")) {
              openMarkdown(e.path);
            } else {
              openRaw(e.path);
            }
          }
        });
        list.appendChild(li);
      }
    }

    function setCrumb(path){
      document.getElementById("crumb").textContent = "/" + (path || "");
    }

    async function openDir(path=""){
      cwd = path;
      setCrumb(cwd);
      try {
        const data = await fetchJSON(api(cwd));
        entries = sortEntries(data);
        renderList(entries);
      } catch (e){
        console.error("openDir failed:", e);
        entries = [];
        renderList(entries);
      }
    }

    async function headExists(path){
      try{
        const r = await fetch(raw(path), { method:"HEAD", cache:"no-store" });
        return r.ok;
      } catch { return false; }
    }

    async function resolveMdForLang(path){
      const lang = (I18n && I18n.lang) || "de";
      const lower = path.toLowerCase();
      if (lang === "en"){
        if (lower.endsWith(".en.md")) return path;
        if (lower.endsWith(".de.md")){
          const p = path.replace(/\.de\.md$/i, ".en.md");
          if (await headExists(p)) return p;
        } else if (lower.endsWith(".md")){
          const p = path.replace(/\.md$/i, ".en.md");
          if (await headExists(p)) return p;
        }
      }
      return path; // fallback: original
    }

    async function openMarkdown(path){
      // Determine EN variant if chosen
      const chosen = await resolveMdForLang(path);
      currentFilePath = chosen;
      currentRawUrl = raw(chosen);

      document.getElementById("btnOpenRaw").onclick = () => window.open(currentRawUrl, "_blank");
      document.getElementById("btnPdf").onclick = () => window.print();

      try{
        const r = await fetch(currentRawUrl, { cache: "no-store" });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        const text = await r.text();
        // Render markdown safely
        const html = DOMPurify.sanitize(marked.parse(text));
        document.getElementById("md").innerHTML = html;
        // Scroll to top
        document.querySelector(".right").scrollTop = 0;
      } catch(e){
        document.getElementById("md").innerHTML = `<p style="color:#f66">Failed to load ${chosen}: ${e.message}</p>`;
      }
    }

    function openRaw(path){
      const url = raw(path);
      window.open(url, "_blank");
    }

    // Search typing
    document.getElementById("q").addEventListener("input", () => renderList(entries));

    // Language init
    document.addEventListener("DOMContentLoaded", async () => {
      await I18n.init({ defaultLang: "de" });
      // Initial directory: repo root
      openDir("");
    });
  </script>
</body>
</html>
