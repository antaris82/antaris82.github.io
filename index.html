<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sierpinski Project</title>
  <style>
    :root {
      --bg: #0b1117;
      --panel: #0e141b;
      --muted: #8aa0b4;
      --fg: #e7eef5;
      --accent: #5ba8ff;
      --border: #1b2632;
      --ok: #37c978;
      --warn: #ffb020;
      --err: #ff5a5a;
      --content-max: 1320px;
      --content-pad: 32px;
    }
    html, body { height: 100%; }
    body {
      margin: 0; color: var(--fg);
      background:
        linear-gradient(rgba(11,17,23,.86), rgba(11,17,23,.86)),
        url('background.png') center / cover fixed no-repeat;
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .container { width: min(var(--content-max), 100% - var(--content-pad)*2); margin: 0 auto; }

    header {
      position: sticky; top:0; z-index:5;
      background: var(--panel); border-bottom:1px solid var(--border);
    }
    header .inner {
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 0;
    }
    .title { display:flex; gap:12px; align-items: baseline; }
    .title h1 { margin:0; font-size: 18px; }
    .title span { color: var(--muted); font-size: 13px; }

    .header-right { display:flex; align-items:center; gap:16px; }
    .manifest-chip {
      display:flex; align-items:center; gap:6px; font-size:12px; color: var(--muted);
      border:1px solid var(--border); padding:6px 8px; border-radius:8px; background:#0c131a;
      white-space: nowrap;
    }
    .dot { width:8px; height:8px; border-radius:50%; background: var(--warn); flex: 0 0 8px; }
    .dot.ok { background: var(--ok); }
    .dot.err { background: var(--err); }

    .lang { display:flex; align-items:center; gap:8px; }
    .lang label { color: var(--muted); }
    .lang select {
      background:#0e141b; color:var(--fg);
      border:1px solid #26303c; border-radius:8px; padding:6px 10px;
    }

    main { background: transparent; }
    .app { display:grid; grid-template-columns: 360px 1fr; min-height: calc(100vh - 56px); gap: 24px; padding: 18px 0 28px; }
    .left {
      border: 1px solid var(--border); background: #0c1218; border-radius: 12px; overflow:auto;
    }
    .right {
      border: 1px solid var(--border); background: #0c1218; border-radius: 12px; overflow:auto;
    }

    .left .section { padding: 12px 14px; border-bottom: 1px solid var(--border); }
    .section h2 { margin:0 0 8px; font-size:13px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }

    .search { padding: 0 14px 12px; border-bottom: 1px solid var(--border); }
    .search input {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #24303c;
      background:#0f1720; color:var(--fg);
    }

    .crumb { padding: 8px 14px; border-bottom: 1px solid var(--border); font-size: 12px; color: var(--muted); }
    .crumb a { color: var(--muted); }
    .crumb a:hover { color: var(--fg); }

    .list { list-style: none; margin:0; padding:6px; }
    .item {
      display:grid; grid-template-columns: 24px 1fr auto; align-items:center;
      gap:10px; padding:8px 10px; border-radius:8px; cursor:pointer;
      color: #fff; /* immer wei√ü */
    }
    .item:hover { background:#111a23; }
    .item .name { overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .item .meta { color: var(--muted); font-size:12px; }
    .item.active { background:#122236; }

    .viewer { padding: 18px 22px 60px; }
    .viewer .bar {
      display:flex; align-items:center; gap:8px; justify-content: space-between;
      position: sticky; top:0; padding: 10px 0; background: linear-gradient(#0c1218,#0c1218);
      z-index: 3;
    }
    .viewer .btns { display:flex; gap:8px; }
    .btn {
      background:#0f1922; border:1px solid #26303c; color: var(--fg);
      padding:8px 10px; border-radius:8px; cursor:pointer;
    }
    .btn:hover { background:#122436; }
    .muted { color: var(--muted); }

    .md, .generic { max-width: 980px; margin: 0 auto; }
    .md h1, .md h2, .md h3, .md h4 { margin-top: 1.6em; }
    .md pre { background:#0f1922; padding:12px; border-radius:10px; overflow:auto; border:1px solid #223042; }
    .md code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .md table { border-collapse: collapse; border:1px solid #223042; }
    .md table th, .md table td { border:1px solid #223042; padding:6px 8px; }
    .md img { max-width: 100%; }

    .viewer .preview, .viewer img.preview, .viewer video.preview, .viewer audio.preview {
      width: 100%;
      max-width: 980px;
      border: 1px solid #223042;
      border-radius: 10px;
      background:#0f1922;
      display:block;
      margin: 0 auto;
    }
    .viewer img.preview { height: auto; }

    pre.codebox {
      background:#0f1922; padding:12px; border-radius:10px; overflow:auto; border:1px solid #223042;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      white-space: pre; max-height: 78vh;
    }

    footer {
      border-top:1px solid var(--border);
      padding: 10px 0; color: var(--muted); background: var(--panel);
    }
    footer .inner { display:flex; align-items:center; justify-content:space-between; }
    footer a { color: var(--muted); text-decoration: underline; }

    /* Print */
    @media print {
      header, .left, .viewer .bar, footer { display:none !important; }
      .app { display:block; }
      body { background:#fff; color:#000; }
      .md pre, pre.codebox { border:1px solid #ccc; background:#fafafa; color:#111; }
    }
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
  <!-- Syntax Highlighting -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  <!-- CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- KaTeX (LaTeX) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
  <!-- PDF.js Legacy (setzt window.pdfjsLib) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/legacy/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/legacy/build/pdf.worker.min.js";
  </script>

  <!-- i18n runtime -->
  <script src="assets/i18n.js"></script>
</head>
<body>
  <header>
    <div class="container inner">
      <div class="title">
        <h1 data-i18n="app.title">Sierpinski-Tetraeder ‚Äì Projekt</h1>
        <span class="muted" data-i18n="app.subtitle">Experiment, Dokumentation und Materialien</span>
      </div>
      <div class="header-right">
        <div id="manifestChip" class="manifest-chip" title="manifest.json">
          <span class="dot" id="manifestDot"></span>
          <span id="manifestText">manifest‚Ä¶</span>
        </div>
        <div class="lang">
          <label for="langSelect" data-i18n="app.language">Sprache</label>
          <select id="langSelect" aria-label="Language">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="app">
      <!-- Browser -->
      <aside class="left">
        <div class="section"><h2 data-i18n="browser.title">Dateibrowser</h2></div>
        <div class="search">
          <input id="q" type="search" placeholder="Suchen ‚Ä¶"
                data-i18n="search" data-i18n-attr="placeholder" data-i18n-search="search.placeholder">
        </div>
        <div class="crumb" id="crumb"></div>
        <ul id="list" class="list"></ul>
      </aside>

      <!-- Viewer -->
      <section class="right">
        <div class="viewer">
          <div class="bar">
            <div class="muted" id="currentName">‚Äî</div>
            <div class="btns">
              <button id="btnOpenRaw" class="btn" data-i18n="viewer.openRaw">Rohdatei √∂ffnen</button>
              <button id="btnPdf" class="btn" data-i18n="viewer.downloadPdf">Als PDF exportieren</button>
            </div>
          </div>
          <article id="md" class="md" hidden></article>
          <div id="generic" class="generic" hidden></div>
        </div>
      </section>
    </section>
  </main>

  <footer>
    <div class="container inner">
      <span id="copyright"></span>
      <span class="muted">antaris82.github.io</span>
    </div>
  </footer>

  <script>
    /* =========================
       Manifest-basierter Browser
       ========================= */
    let MANIFEST = null;
    let NODES = new Map();      // path -> node { path, name, type:'file'|'dir', size?:number }
    let CHILDREN = new Map();   // dirPath -> [node,...]
    let cwd = "";
    let lastMdBasePath = null;
    let currentRawUrl = null;

    // ---- Utils ----
    const pathDir = p => (p.split("/").slice(0, -1).join("/"));
    const baseName = p => (p.split("/").pop() || "");
    const ext = name => (name.toLowerCase().match(/\.([a-z0-9]+)$/)?.[1] || "");
    const isTextExt = e => ["txt","log","md","markdown","csv","tsv","json","xml","yml","yaml","ini","conf","sh","py","js","ts","css","html","svg","java","c","cpp","h","hpp","cs","go","rs","php","rb","kt","swift","sql","toml"].includes(e);
    const isImageExt = e => ["png","jpg","jpeg","gif","webp","avif","bmp","svg"].includes(e);
    const isAudioExt = e => ["mp3","wav","ogg","m4a","aac","flac"].includes(e);
    const isVideoExt = e => ["mp4","webm","ogv","mov"].includes(e);
    const isPdfExt = e => e === "pdf";
    const fmtSize = bytes => {
      if (bytes == null || isNaN(bytes)) return "";
      const units = ["B","KB","MB","GB","TB"];
      let i = 0; let n = +bytes;
      while (n >= 1024 && i < units.length-1){ n/=1024; i++; }
      return (Math.round(n*10)/10) + " " + units[i];
    };

    // same-origin URL mit Encoding f√ºr Leerzeichen/Umlaute/‚Äî ‚Ä¶
    const urlFor = p => encodeURI((p || "").replace(/^\/+/, ""));

    async function fetchJSON(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }
    async function fetchText(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.text();
    }
    async function fetchArrayBuffer(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.arrayBuffer();
    }

    // ---- Manifest normalisieren ----
    function normalizeEntries(raw) {
      const out = [];
      const take = (e) => {
        let p = e.path || e.file || null;
        if (!p) return;
        p = p.replace(/^\/+/,"");
        let t = e.type;
        if (t === "blob") t = "file";
        if (t === "tree") t = "dir";
        if (!t) t = "file";
        const node = { path: p, name: baseName(p), type: (t === "dir" ? "dir" : "file") };
        if (typeof e.size === "number") node.size = e.size;
        out.push(node);
      };
      if (Array.isArray(raw)) {
        raw.forEach(take);
      } else if (raw && typeof raw === "object") {
        if (Array.isArray(raw.entries)) raw.entries.forEach(take);
        else if (Array.isArray(raw.tree)) raw.tree.forEach(take);
        else if (Array.isArray(raw.items)) raw.items.forEach(take);
      }
      return out;
    }

    function indexEntries(nodes) {
      NODES.clear(); CHILDREN.clear();
      for (const n of nodes) NODES.set(n.path, n);
      // fehlende Verzeichnisse aus Pfaden erzeugen
      for (const n of nodes) {
        const parts = n.path.split("/").slice(0, -1);
        let acc = "";
        for (const seg of parts) {
          acc = acc ? acc + "/" + seg : seg;
          if (!NODES.has(acc)) NODES.set(acc, { path: acc, name: seg, type: "dir" });
        }
      }
      for (const n of NODES.values()) {
        const parent = pathDir(n.path);
        if (!CHILDREN.has(parent)) CHILDREN.set(parent, []);
        CHILDREN.get(parent).push(n);
      }
      for (const [k, arr] of CHILDREN) {
        arr.sort((a,b)=>{
          if (a.type !== b.type) return a.type === "dir" ? -1 : 1;
          return a.name.localeCompare(b.name, undefined, {numeric:true});
        });
      }
    }

    // ---- UI: Breadcrumbs / Liste ----
    function crumbHtml(path){
      const parts = path ? path.split("/").filter(Boolean) : [];
      const items = ['<a href="#" data-path="">/</a>'];
      let acc = "";
      for (const p of parts){
        acc = acc ? acc + "/" + p : p;
        items.push(`<a href="#" data-path="${acc}">${p}</a>`);
      }
      return items.join(" / ");
    }
    function renderCrumb(){
      const el = document.getElementById("crumb");
      el.innerHTML = crumbHtml(cwd);
      el.querySelectorAll("a").forEach(a=>{
        a.addEventListener("click", (e)=>{
          e.preventDefault();
          openDir(a.dataset.path||"");
        });
      });
    }

    function renderList(){
      const q = (document.getElementById("q").value || "").trim().toLowerCase();
      const list = document.getElementById("list");
      list.innerHTML = "";

      if (cwd){
        const up = document.createElement("li");
        up.className = "item";
        up.innerHTML = `<span class="meta">‚¨ÜÔ∏è</span><span class="name" data-i18n="viewer.up">.. (Ebene h√∂her)</span><span class="meta">UP</span>`;
        up.addEventListener("click", ()=> openDir(pathDir(cwd)));
        list.appendChild(up);
        I18n.apply();
      }

      const children = (CHILDREN.get(cwd) || []).filter(e => !q || e.name.toLowerCase().includes(q));
      if (!children.length){
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `<span class="meta">‚Äî</span><span class="name" data-i18n="browser.empty">Keine Dateien gefunden.</span><span class="meta"></span>`;
        list.appendChild(li);
        I18n.apply();
        return;
      }

      for (const e of children){
        const li = document.createElement("li");
        li.className = "item";
        li.dataset.path = e.path;
        const icon = e.type === "dir" ? "üìÅ" : "üìÑ";
        const extension = e.type === "dir" ? "DIR" : (ext(e.name).toUpperCase() || "FILE");
        const size = e.type === "dir" ? "" : fmtSize(e.size);

        li.innerHTML = `
          <span class="meta">${icon}</span>
          <span class="name">${e.name}</span>
          <span class="meta">${extension}${size ? " ‚Ä¢ " + size : ""}</span>
        `;
        li.addEventListener("click", () => {
          document.querySelectorAll(".item.active").forEach(n => n.classList.remove("active"));
          li.classList.add("active");
          if (e.type === "dir") openDir(e.path);
          else openFile(e.path);
        });
        list.appendChild(li);
      }
    }

    async function openDir(path=""){
      cwd = path;
      renderCrumb();
      renderList();
    }

    // ---- Manifest-Anzeige ----
    function updateManifestChip(){
      const dot = document.getElementById("manifestDot");
      const txt = document.getElementById("manifestText");
      try {
        const files = [...NODES.values()].filter(n => n.type === "file").length;
        const dirs  = [...NODES.values()].filter(n => n.type === "dir").length;
        const t = MANIFEST?.indexedAt || MANIFEST?.generatedAt || MANIFEST?.timestamp || null;
        const d = t ? new Date(t) : new Date();
        const locale = (I18n && I18n.lang === "en") ? "en-GB" : "de-DE";
        const stamp = d.toLocaleString(locale, { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
        const label = `${files} ${I18n.t("status.files","Dateien")} ‚Ä¢ ${dirs} ${I18n.t("status.folders","Ordner")} ‚Ä¢ ${I18n.t("status.indexedAt","Stand")}: ${stamp}`;
        txt.textContent = label;
        dot.classList.add("ok");
      } catch {
        dot.classList.remove("ok"); dot.classList.add("err");
        txt.textContent = I18n.t("status.manifestInvalid","Manifest ung√ºltig");
      }
    }

    /* =========================
       Viewer (alle Dateitypen)
       ========================= */
    function showMd(html, titleText){
      const md = document.getElementById("md");
      const gen = document.getElementById("generic");
      gen.hidden = true; gen.innerHTML = "";
      md.hidden = false; md.innerHTML = html;
      document.getElementById("currentName").textContent = titleText || "‚Äî";
      document.querySelectorAll("#md pre code").forEach(block => hljs.highlightElement(block));
      try {
        renderMathInElement(md, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "\\(", right: "\\)", display: false},
            {left: "$", right: "$", display: false}
          ],
          throwOnError: false
        });
      } catch(e) { console.warn("katex render failed", e); }
    }
    function showGeneric(node, titleText){
      const md = document.getElementById("md");
      const gen = document.getElementById("generic");
      md.hidden = true; md.innerHTML = "";
      gen.hidden = false; gen.innerHTML = "";
      gen.appendChild(node);
      document.getElementById("currentName").textContent = titleText || "‚Äî";
    }

    function existsInManifest(path){
      return NODES.has((path || "").replace(/^\/+/,""));
    }

    async function openMarkdown(path){
      // Sprachvariante w√§hlen
      lastMdBasePath = path.replace(/\.en\.md$/i, ".md").replace(/\.de\.md$/i, ".md");
      const lang = I18n.lang || "de";
      let chosen = path;
      if (lang === "en"){
        if (path.toLowerCase().endsWith(".md") && !path.toLowerCase().endsWith(".en.md")){
          const candidate = path.replace(/\.md$/i, ".en.md");
          if (existsInManifest(candidate)) chosen = candidate;
        }
        if (path.toLowerCase().endsWith(".de.md")){
          const candidate = path.replace(/\.de\.md$/i, ".en.md");
          if (existsInManifest(candidate)) chosen = candidate;
        }
      }

      currentRawUrl = urlFor(chosen);
      document.getElementById("btnOpenRaw").onclick = () => window.open(currentRawUrl, "_blank");
      document.getElementById("btnPdf").onclick = () => window.print();

      try{
        const text = await fetchText(currentRawUrl);
        marked.setOptions({ breaks: false });
        const html = DOMPurify.sanitize(marked.parse(text));
        showMd(html, chosen.split("/").pop());
        document.querySelector(".right").scrollTop = 0;
      } catch(e){
        const p = document.createElement("p");
        p.style.color = "#ff8080";
        p.textContent = `${I18n.t("errors.loadFailed","Datei konnte nicht geladen werden")}: ${e.message}`;
        showGeneric(p, chosen.split("/").pop());
      }
    }

    async function openText(path){
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick = () => window.open(currentRawUrl, "_blank");
      document.getElementById("btnPdf").onclick = () => window.print();

      const pre = document.createElement("pre");
      pre.className = "codebox";
      try{
        const text = await fetchText(currentRawUrl);
        const code = document.createElement("code");
        code.textContent = text;
        const language = ext(path);
        if (language) code.className = `language-${language}`;
        pre.appendChild(code);
        hljs.highlightElement(code);
      } catch(e){
        pre.textContent = `${I18n.t("errors.loadFailed","Datei konnte nicht geladen werden")}: ${e.message}`;
      }
      showGeneric(pre, path.split("/").pop());
    }

    async function openCsv(path){
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick = () => window.open(currentRawUrl, "_blank");
      document.getElementById("btnPdf").onclick = () => window.print();

      const wrap = document.createElement("div");
      try{
        const text = await fetchText(currentRawUrl);
        const parsed = Papa.parse(text.trim());
        const table = document.createElement("table");
        table.className = "md";
        parsed.data.forEach((row,i)=>{
          const tr = document.createElement("tr");
          row.forEach(cell=>{
            const td = document.createElement(i===0 ? "th" : "td");
            td.textContent = cell;
            tr.appendChild(td);
          });
          table.appendChild(tr);
        });
        wrap.appendChild(table);
      } catch(e){
        const p = document.createElement("p");
        p.style.color = "#ff8080";
        p.textContent = `${I18n.t("errors.loadFailed","Datei konnte nicht geladen werden")}: ${e.message}`;
        wrap.appendChild(p);
      }
      showGeneric(wrap, path.split("/").pop());
    }

    async function openPdf(path){
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick = () => window.open(currentRawUrl, "_blank");
      document.getElementById("btnPdf").onclick = () => window.print();

      // Wenn PDF.js nicht verf√ºgbar ‚Üí Fallback iframe
      if (typeof window.pdfjsLib === "undefined") {
        const frame = document.createElement("iframe");
        frame.className = "preview";
        frame.src = currentRawUrl;
        frame.setAttribute("title", path.split("/").pop());
        frame.style.height = "78vh";
        showGeneric(frame, path.split("/").pop());
        return;
      }

      const container = document.createElement("div");
      container.className = "preview";
      container.style.padding = "16px";
      container.style.background = "#0f1922";
      container.style.borderRadius = "10px";
      container.style.maxWidth = "980px";
      container.style.margin = "0 auto";

      try{
        const data = await fetchArrayBuffer(currentRawUrl);
        const pdf = await pdfjsLib.getDocument({ data }).promise;

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++){
          const page = await pdf.getPage(pageNum);
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          canvas.style.display = "block";
          canvas.style.margin = "0 auto 12px";
          await page.render({ canvasContext: ctx, viewport }).promise;
          container.appendChild(canvas);
        }
        showGeneric(container, path.split("/").pop());
      } catch (e){
        // Fallback: iframe
        const frame = document.createElement("iframe");
        frame.className = "preview";
        frame.src = currentRawUrl;
        frame.setAttribute("title", path.split("/").pop());
        frame.style.height = "78vh";
        showGeneric(frame, path.split("/").pop());
      }
    }

    function openImage(path){
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick = () => window.open(currentRawUrl, "_blank");
      document.getElementById("btnPdf").onclick = () => window.print();

      const img = document.createElement("img");
      img.className = "preview";
      img.src = currentRawUrl;
      img.alt = path.split("/").pop();
      showGeneric(img, img.alt);
    }

    function openAudio(path){
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick = () => window.open(currentRawUrl, "_blank");
      document.getElementById("btnPdf").onclick = () => window.print();

      const audio = document.createElement("audio");
      audio.className = "preview";
      audio.controls = true;
      audio.src = currentRawUrl;
      showGeneric(audio, path.split("/").pop());
    }

    function openVideo(path){
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick = () => window.open(currentRawUrl, "_blank");
      document.getElementById("btnPdf").onclick = () => window.print();

      const video = document.createElement("video");
      video.className = "preview";
      video.controls = true;
      video.src = currentRawUrl;
      showGeneric(video, path.split("/").pop());
    }

    function openRawFile(path){
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick = () => window.open(currentRawUrl, "_blank");
      document.getElementById("btnPdf").onclick = () => window.print();

      const frame = document.createElement("iframe");
      frame.className = "preview";
      frame.src = currentRawUrl;
      frame.setAttribute("title", path.split("/").pop());
      frame.style.height = "78vh";
      showGeneric(frame, path.split("/").pop());
    }

    function openFile(path){
      const e = ext(path);
      if (e === "md" || e === "markdown" || e === "mdown") return openMarkdown(path);
      if (isPdfExt(e)) return openPdf(path);
      if (isImageExt(e)) return openImage(path);
      if (isAudioExt(e)) return openAudio(path);
      if (isVideoExt(e)) return openVideo(path);
      if (e === "csv" || e === "tsv") return openCsv(path);
      if (isTextExt(e)) return openText(path);
      return openRawFile(path);
    }

    /* =========================
       Manifest laden / UI init
       ========================= */
    async function loadManifest(){
      try {
        const m = await fetchJSON(`manifest.json?ts=${Date.now()}`); // Cache-Bust
        MANIFEST = m;
        const norm = normalizeEntries(m);
        if (!norm.length) throw new Error("manifest.json enth√§lt keine Eintr√§ge.");
        indexEntries(norm);
        return true;
      } catch (e){
        console.error("manifest.json laden fehlgeschlagen:", e);
        MANIFEST = {};
        NODES.clear(); CHILDREN.clear();
        NODES.set("", { path:"", name:"", type:"dir" });
        CHILDREN.set("", []);

        const list = document.getElementById("list");
        if (list) {
          list.innerHTML = `
            <li class="item">
              <span class="meta">‚ö†Ô∏è</span>
              <span class="name">manifest.json konnte nicht geladen werden. √ñffne die Seite √ºber HTTPS / GitHub Pages oder einen lokalen Server.</span>
              <span class="meta"></span>
            </li>`;
        }
        return false;
      }
    }

    function updateManifestUI(){
      updateManifestChip();
      renderList();
    }

    function renderFooter(){
      const y = new Date().getFullYear();
      document.getElementById("copyright").textContent =
        I18n.lang === "en"
          ? `¬© ${y} antaris ‚Äî Code: MIT; Data/Figures/Texts (incl. PDFs): CC BY 4.0.`
          : `¬© ${y} antaris ‚Äî Code: MIT; Daten/Abbildungen/Texte (inkl. PDFs): CC BY 4.0.`;
    }

    // Suche
    document.getElementById("q").addEventListener("input", renderList);

    // Sprache wechseln
    document.getElementById("langSelect").addEventListener("change", async (e) => {
      await I18n.set(e.target.value);
      renderFooter();
      updateManifestUI();
      if (lastMdBasePath) openMarkdown(lastMdBasePath);
    });

    // Init
    document.addEventListener("DOMContentLoaded", async () => {
      // Lokales √ñffnen via file:// abfangen (fetch blockiert sonst)
      if (location.protocol === "file:") {
        const list = document.getElementById("list");
        if (list) {
          list.innerHTML = `
            <li class="item">
              <span class="meta">‚ÑπÔ∏è</span>
              <span class="name">Bitte √ºber einen lokalen Server (z. B. <code>python -m http.server</code>) oder GitHub Pages √∂ffnen. <code>file://</code> blockiert <code>fetch</code>.</span>
              <span class="meta"></span>
            </li>`;
        }
        return;
      }

      await I18n.init({ defaultLang: "de" });
      renderFooter();
      await loadManifest();
      updateManifestUI();
      await openDir(""); // Start im Root
    });
  </script>
</body>
</html>
