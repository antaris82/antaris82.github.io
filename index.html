<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sierpinski ‚Äì Reader</title>
  <style>
    :root { --bg:#0b1117; --fg:#e7eef5; --muted:#8aa0b4; --panel:#0e141b; --border:#1b2632; --accent:#5ba8ff; }
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    .container{width:min(1280px,100% - 32px);margin:0 auto}
    header{position:sticky;top:0;z-index:2;background:var(--panel);border-bottom:1px solid var(--border)}
    header .row{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted)}
    .app{display:grid;grid-template-columns:360px 1fr;gap:20px;min-height:calc(100vh - 56px);padding:16px 0 28px}
    .card{border:1px solid var(--border);background:#0c1218;border-radius:12px;overflow:auto}
    .left .section{padding:12px 14px;border-bottom:1px solid var(--border)}
    .left .search{padding:10px 14px;border-bottom:1px solid var(--border)}
    .left input{width:100%;padding:10px;border-radius:10px;border:1px solid #24303c;background:#0f1720;color:var(--fg)}
    .crumb{padding:8px 14px;border-bottom:1px solid var(--border);color:var(--muted);font-size:12px}
    .list{list-style:none;margin:0;padding:6px}
    .item{display:grid;grid-template-columns:24px 1fr auto;gap:10px;align-items:center;padding:8px 10px;border-radius:8px;cursor:pointer}
    .item:hover{background:#111a23}.item .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.item .meta{color:var(--muted);font-size:12px}
    .viewer{padding:18px 22px 60px}
    .viewer .bar{display:flex;align-items:center;justify-content:space-between;gap:10px;position:sticky;top:0;background:#0c1218;padding:10px 0;z-index:1}
    .btn{background:#0f1922;border:1px solid #26303c;color:var(--fg);padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn:hover{background:#122436}
    .preview,.viewer img.preview{width:100%;max-width:980px;border:1px solid #223042;border-radius:10px;background:#0f1922;display:block;margin:0 auto}
    .md{max-width:980px;margin:0 auto}
    .md pre{background:#0f1922;border:1px solid #223042;border-radius:10px;padding:12px;overflow:auto}
    #err{position:fixed;left:0;right:0;bottom:0;background:#3a1116;color:#ffd6d6;border-top:1px solid #6b1a23;padding:8px 14px;font-size:12px;display:none;z-index:9}
  </style>

  <!-- Markdown, sanitize, highlight -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  <!-- KaTeX (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
</head>
<body>
<header>
  <div class="container row">
    <div>
      <h1>Sierpinski-Tetraeder</h1>
      <div class="muted">Reader & Dateibrowser</div>
    </div>
    <button id="refresh" class="btn">‚Üª</button>
  </div>
</header>

<main class="container app">
  <aside class="card left">
    <div class="section"><strong>Dateibrowser</strong></div>
    <div class="search"><input id="q" type="search" placeholder="Suchen ‚Ä¶"></div>
    <div class="crumb" id="crumb"></div>
    <ul id="list" class="list"></ul>
  </aside>

  <section class="card right">
    <div class="viewer">
      <div class="bar">
        <div class="muted" id="cur">‚Äî</div>
        <div>
          <button id="openRaw" class="btn">Rohdatei</button>
          <button id="print" class="btn">Als PDF</button>
        </div>
      </div>
      <!-- Startbild immer sichtbar -->
      <img id="hero" class="preview" src="/Sierpinski-Tetraeder.png" alt="Sierpinski-Tetraeder.png">
      <article id="md" class="md" hidden></article>
      <div id="generic" hidden></div>
    </div>
  </section>
</main>

<div id="err"></div>

<script>
// ------- error banner -------
(function(){
  const E = document.getElementById("err");
  const show = msg => { E.textContent = "Fehler: " + msg; E.style.display="block"; };
  window.addEventListener("error", e => show(e.message || e.error || e));
  window.addEventListener("unhandledrejection", e => show(e.reason || e));
})();

// ------- config -------
const START_DIR = "Sierpinski Tetraeder_PoC";
const urlRaw = p => "/"+encodeURI(String(p||"").replace(/^\/+/,""));

let NODES=new Map(), CHILDREN=new Map(), cwd="", current=null;

// ------- utils -------
const base = p => (p||"").split("/").pop()||"";
const dir  = p => (p||"").split("/").slice(0,-1).join("/");
const ext  = n => (n.toLowerCase().match(/\.([a-z0-9]+)$/)?.[1]||"");
const isImg = e => ["png","jpg","jpeg","gif","webp","svg","avif","bmp"].includes(e);
const isPdf = e => e==="pdf";
const isAud = e => ["mp3","wav","ogg","m4a","aac","flac"].includes(e);
const isVid = e => ["mp4","webm","ogv","mov"].includes(e);
const isTxt = e => ["txt","log","md","markdown","csv","tsv","json","xml","yml","yaml","ini","conf","sh","py","js","ts","css","html","svg","java","c","cpp","h","hpp","cs","go","rs","php","rb","kt","swift","sql","toml"].includes(e);

async function j(u){const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(r.status+" "+r.statusText); return r.json();}
async function t(u){const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(r.status+" "+r.statusText); return r.text();}

function renderCrumb(){const el=document.getElementById("crumb"); const parts=cwd?cwd.split("/").filter(Boolean):[]; const items=['<a href="#" data-path="">/</a>']; let acc=""; for(const p of parts){acc=acc?acc+"/"+p:p; items.push(`<a href="#" data-path="${acc}">${p}</a>`);} el.innerHTML=items.join(" / "); el.querySelectorAll("a").forEach(a=>a.onclick=(e)=>{e.preventDefault(); openDir(a.dataset.path||"");});}

function renderList(){
  const q=(document.getElementById("q").value||"").trim().toLowerCase();
  const list=document.getElementById("list"); list.innerHTML="";
  if(cwd){
    const up=document.createElement("li"); up.className="item";
    up.innerHTML='<span class="meta">‚¨ÜÔ∏è</span><span class="name">..</span><span class="meta">UP</span>';
    up.onclick=()=>openDir(dir(cwd)); list.appendChild(up);
  }
  const ch=(CHILDREN.get(cwd)||[]).filter(e=>!q||e.name.toLowerCase().includes(q));
  if(!ch.length){const li=document.createElement("li"); li.className="item"; li.innerHTML='<span class="meta">‚Äî</span><span class="name">Keine Dateien</span><span class="meta"></span>'; list.appendChild(li); return;}
  for(const e of ch){
    const li=document.createElement("li"); li.className="item"; li.dataset.path=e.path;
    const icon=e.type==="dir"?"üìÅ":"üìÑ"; const extn=e.type==="dir"?"DIR":(ext(e.name)||"file").toUpperCase();
    li.innerHTML=`<span>${icon}</span><span class="name">${e.name}</span><span class="meta">${extn}</span>`;
    li.onclick=()=>{ if(e.type==="dir") openDir(e.path); else openFile(e.path); };
    list.appendChild(li);
  }
}

async function openDir(path=""){cwd=path; renderCrumb(); renderList();}

function showGeneric(node,title){
  document.getElementById("hero")?.remove();
  const md=document.getElementById("md"), gen=document.getElementById("generic");
  md.hidden=true; md.innerHTML=""; gen.hidden=false; gen.innerHTML=""; gen.appendChild(node);
  document.getElementById("cur").textContent = title||"‚Äî";
}

function waitKatex(){return new Promise((res,rej)=>{let n=0;(function step(){if(window.renderMathInElement) return res(); if(++n>200) return rej(new Error("KaTeX nicht verf√ºgbar")); setTimeout(step,30);})();});}

async function openMarkdown(path){
  current = path; const raw=urlRaw(path);
  document.getElementById("openRaw").onclick=()=>window.open(raw,"_blank");
  document.getElementById("print").onclick=()=>window.print();
  try{
    const txt = await t(raw);
    marked.setOptions({gfm:true, breaks:false});
    const html = DOMPurify.sanitize(marked.parse(txt));
    document.getElementById("hero")?.remove();
    const md=document.getElementById("md"); const gen=document.getElementById("generic");
    gen.hidden=true; gen.innerHTML=""; md.hidden=false; md.innerHTML=html;
    document.querySelectorAll("#md pre code").forEach(b=>hljs.highlightElement(b));
    try{ await waitKatex(); renderMathInElement(md, {
      delimiters:[
        {left:"$$", right:"$$", display:true},
        {left:"\\[", right:"\\]", display:true},
        {left:"\\(", right:"\\)", display:false},
        {left:"$",  right:"$",  display:false}
      ],
      throwOnError:false, strict:"ignore"
    }); }catch(e){ console.warn(e); }
    document.getElementById("cur").textContent = base(path);
  }catch(e){
    const p=document.createElement("p"); p.style.color="#ff9a9a"; p.textContent="Datei konnte nicht geladen werden: "+e.message;
    showGeneric(p, base(path));
  }
}

function openImage(path){
  current = path; const raw=urlRaw(path);
  document.getElementById("openRaw").onclick=()=>window.open(raw,"_blank");
  document.getElementById("print").onclick=()=>window.print();
  const img=document.createElement("img"); img.className="preview"; img.src=raw; img.alt=base(path);
  showGeneric(img, base(path));
}

function openText(path){
  current=path; const raw=urlRaw(path);
  document.getElementById("openRaw").onclick=()=>window.open(raw,"_blank");
  document.getElementById("print").onclick=()=>window.print();
  const pre=document.createElement("pre"); pre.className="md"; pre.style.padding="12px";
  t(raw).then(v=>pre.textContent=v).catch(e=>pre.textContent="Datei konnte nicht geladen werden: "+e.message);
  showGeneric(pre, base(path));
}

function openRaw(path){
  current=path; const raw=urlRaw(path);
  document.getElementById("openRaw").onclick=()=>window.open(raw,"_blank");
  document.getElementById("print").onclick=()=>window.print();
  const frame=document.createElement("iframe"); frame.className="preview"; frame.src=raw; frame.title=base(path); frame.style.height="78vh";
  showGeneric(frame, base(path));
}

function openFile(path){
  const e=ext(path);
  if(e==="md"||e==="markdown") return openMarkdown(path);
  if(isImg(e)) return openImage(path);
  if(isTxt(e)) return openText(path);
  return openRaw(path);
}

// ------- manifest load & boot -------
function indexEntries(raw){
  NODES.clear(); CHILDREN.clear();
  const out=[]; const take=e=>{ let p=e.path||e.file||e.name||""; if(!p) return;
    p=String(p).replace(/^\/+/,""); const type=(e.type==="tree"||e.type==="dir")?"dir":"file";
    out.push({path:p, name:base(p), type});
  };
  if(Array.isArray(raw)) raw.forEach(take);
  else if(raw && typeof raw==="object"){ (raw.entries||raw.tree||raw.items||[]).forEach(take); }
  out.forEach(n=>NODES.set(n.path,n));
  for(const n of out){ const parent=dir(n.path); if(!CHILDREN.has(parent)) CHILDREN.set(parent,[]); CHILDREN.get(parent).push(n); }
  for(const [k,a] of CHILDREN){ a.sort((a,b)=> (a.type!==b.type)?(a.type==="dir"?-1:1):a.name.localeCompare(b.name,undefined,{numeric:true})); }
}

async function boot(){
  try{
    const m = await j("/manifest.json?ts="+Date.now());
    indexEntries(m);
  }catch(e){
    document.getElementById("list").innerHTML = '<li class="item"><span>‚ö†Ô∏è</span><span class="name">manifest.json nicht gefunden</span><span class="meta"></span></li>';
  }
  await openDir(START_DIR);
}

document.getElementById("q").addEventListener("input", renderList);
document.getElementById("refresh").addEventListener("click", boot);
document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
