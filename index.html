<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sierpinski Project</title>
  <style>
    :root {
      --bg: #0b1117; --panel: #0e141b; --muted: #8aa0b4; --fg: #e7eef5;
      --accent: #5ba8ff; --border: #1b2632; --ok: #37c978; --warn: #ffb020; --err: #ff5a5a;
      --content-max: 1320px; --content-pad: 32px;
    }
    html, body { height: 100%; }
    body {
      margin: 0; color: var(--fg);
      background:
        linear-gradient(rgba(11,17,23,.86), rgba(11,17,23,.86)),
        url('background.png') center / cover fixed no-repeat;
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { width: min(var(--content-max), 100% - var(--content-pad)*2); margin: 0 auto; }
    header { position: sticky; top:0; z-index:5; background: var(--panel); border-bottom:1px solid var(--border); }
    header .inner { display:flex; align-items:center; justify-content:space-between; padding: 12px 0; }
    .title { display:flex; gap:12px; align-items: baseline; }
    .title h1 { margin:0; font-size: 18px; }
    .title span { color: var(--muted); font-size: 13px; }
    .header-right { display:flex; align-items:center; gap:16px; }
    .manifest-chip {
      display:flex; align-items:center; gap:6px; font-size:12px; color: var(--muted);
      border:1px solid var(--border); padding:6px 8px; border-radius:8px; background:#0c131a; white-space: nowrap;
    }
    .dot { width:8px; height:8px; border-radius:50%; background: var(--warn); flex: 0 0 8px; }
    .dot.ok { background: var(--ok); } .dot.err { background: var(--err); }
    .lang { display:flex; align-items:center; gap:8px; } .lang label { color: var(--muted); }
    .lang select { background:#0e141b; color:var(--fg); border:1px solid #26303c; border-radius:8px; padding:6px 10px; }
    main { background: transparent; }
    .app { display:grid; grid-template-columns: 360px 1fr; min-height: calc(100vh - 56px); gap: 24px; padding: 18px 0 28px; }
    .left, .right { border: 1px solid var(--border); background: #0c1218; border-radius: 12px; overflow:auto; }
    .left .section { padding: 12px 14px; border-bottom: 1px solid var(--border); }
    .section h2 { margin:0 0 8px; font-size:13px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }
    .search { padding: 0 14px 12px; border-bottom: 1px solid var(--border); }
    .search input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #24303c; background:#0f1720; color:var(--fg); }
    .crumb { padding: 8px 14px; border-bottom: 1px solid var(--border); font-size: 12px; color: var(--muted); }
    .crumb a { color: var(--muted); } .crumb a:hover { color: var(--fg); }
    .list { list-style: none; margin:0; padding:6px; }
    .item { display:grid; grid-template-columns: 24px 1fr auto; align-items:center; gap:10px; padding:8px 10px; border-radius:8px; cursor:pointer; color:#fff; }
    .item:hover { background:#111a23; } .item .name { overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .item .meta { color: var(--muted); font-size:12px; } .item.active { background:#122236; }
    .viewer { padding: 18px 22px 60px; }
    .viewer .bar { display:flex; align-items:center; gap:8px; justify-content: space-between; position: sticky; top:0; padding: 10px 0; background: #0c1218; z-index: 3; }
    .viewer .btns { display:flex; gap:8px; }
    .btn { background:#0f1922; border:1px solid #26303c; color: var(--fg); padding:8px 10px; border-radius:8px; cursor:pointer; }
    .btn:hover { background:#122436; } .muted { color: var(--muted); }
    .md, .generic { max-width: 980px; margin: 0 auto; }
    .md h1, .md h2, .md h3, .md h4 { margin-top: 1.6em; }
    .md pre { background:#0f1922; padding:12px; border-radius:10px; overflow:auto; border:1px solid #223042; }
    .md code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .md table { border-collapse: collapse; border:1px solid #223042; }
    .md table th, .md table td { border:1px solid #223042; padding:6px 8px; }
    .md img { max-width: 100%; }
    .viewer .preview, .viewer img.preview, .viewer video.preview, .viewer audio.preview {
      width: 100%; max-width: 980px; border: 1px solid #223042; border-radius: 10px; background:#0f1922; display:block; margin: 0 auto;
    }
    .viewer img.preview { height: auto; }
    pre.codebox { background:#0f1922; padding:12px; border-radius:10px; overflow:auto; border:1px solid #223042;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space: pre; max-height: 78vh; }
    footer { border-top:1px solid var(--border); padding: 10px 0; color: var(--muted); background: var(--panel); }
    footer .inner { display:flex; align-items:center; justify-content:space-between; }
    footer a { color: var(--muted); text-decoration: underline; }
    @media print {
      header, .left, .viewer .bar, footer { display:none !important; }
      .app { display:block; } body { background:#fff; color:#000; }
      .md pre, pre.codebox { border:1px solid #ccc; background:#fafafa; color:#111; }
    }
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- KaTeX (LaTeX) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
  <!-- PDF.js Legacy (setzt window.pdfjsLib) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/legacy/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/legacy/build/pdf.worker.min.js";
  </script>

  <!-- Pyodide (Python im Browser) -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script>
    let __pyodidePromise = null;
    let __pyInstance = null;

    async function loadPyodideOnce() {
      if (!__pyodidePromise) {
        __pyodidePromise = loadPyodide({
          indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/"
        }).then(py => { __pyInstance = py; return py; });
      }
      return __pyodidePromise;
    }

    // Paketerkennung aus Code (pandas, scipy, sympy, networkx, PIL->pillow, imageio)
    function detectPyodidePkgsFromCode(code) {
      const pkgs = new Set();
      const has = (re) => re.test(code);
      if (has(/\bimport\s+pandas\b|\bfrom\s+pandas\s+import\b/)) pkgs.add("pandas");
      if (has(/\bimport\s+numpy\b|\bfrom\s+numpy\s+import\b/)) pkgs.add("numpy");
      if (has(/\bimport\s+matplotlib\b|\bfrom\s+matplotlib\s+import\b/)) pkgs.add("matplotlib");
      if (has(/\bimport\s+scipy\b|\bfrom\s+scipy\s+import\b/)) pkgs.add("scipy");
      if (has(/\bimport\s+sympy\b|\bfrom\s+sympy\s+import\b/)) pkgs.add("sympy");
      if (has(/\bimport\s+networkx\b|\bfrom\s+networkx\s+import\b/)) pkgs.add("networkx");
      if (has(/\bimport\s+PIL\b|\bfrom\s+PIL\s+import\b/)) pkgs.add("pillow");
      if (has(/\bimport\s+imageio\b|\bfrom\s+imageio\s+import\b/)) pkgs.add("imageio");
      return Array.from(pkgs);
    }

    // L√§dt Basis + dynamisch erkannte Pakete
    async function ensurePyPackages(explicit = [], codeForDetect = "") {
      const py = await loadPyodideOnce();
      const detected = detectPyodidePkgsFromCode(codeForDetect);
      const base = ["micropip", "numpy", "matplotlib", "pillow"]; // Basis
      const toLoad = Array.from(new Set([...base, ...explicit, ...detected]));
      if (toLoad.length) await py.loadPackage(toLoad);
      await py.runPythonAsync(`
import matplotlib
matplotlib.use("module://matplotlib_pyodide.html5_canvas_backend")
`);
      return py;
    }

    function appendStdout(outEl, chunk) {
      const lines = String(chunk).split(/\r?\n/);
      for (const line of lines) {
        if (!line) continue;
        if (/^DATA:image\//i.test(line)) {
          const img = document.createElement("img");
          img.src = line.trim();
          img.style.display = "block";
          img.style.maxWidth = "980px";
          img.style.margin = "8px auto";
          img.className = "preview";
          outEl.appendChild(img);
          continue;
        }
        const m = line.match(/^WROTE:\s*(.+)$/i);
        if (m && __pyInstance) {
          try {
            const path = m[1].trim();
            const data = __pyInstance.FS.readFile(path);
            const mime = path.toLowerCase().endsWith(".gif") ? "image/gif"
                      : path.toLowerCase().endsWith(".png") ? "image/png"
                      : "application/octet-stream";
            const blob = new Blob([data], { type: mime });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = path.split("/").pop();
            a.click();
          } catch (e) {
            const span = document.createElement("span");
            span.textContent = `\nDownload fehlgeschlagen: ${e.message}`;
            outEl.appendChild(span);
          }
          continue;
        }
        outEl.append(document.createTextNode(line + "\n"));
      }
    }

    async function runPython(code, outEl, buttonEl=null) {
      const btn = buttonEl;
      try {
        if (btn) { btn.disabled = true; btn.textContent = (I18n?.lang === "en" ? "Running‚Ä¶" : "L√§uft‚Ä¶"); }
        outEl.textContent = "";
        const py = await ensurePyPackages([], code); // dynamische Paket-Erkennung
        py.setStdout({ batched: s => appendStdout(outEl, s) });
        py.setStderr({ batched: s => appendStdout(outEl, s) });
        await py.runPythonAsync(code);
      } catch (err) {
        appendStdout(outEl, "\n" + err);
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = (I18n?.lang === "en" ? "Run Python" : "Python ausf√ºhren"); }
      }
    }
  </script>

  <!-- i18n runtime -->
  <script src="assets/i18n.js"></script>
</head>
<body>
  <header>
    <div class="container inner">
      <div class="title">
        <h1 data-i18n="app.title">Sierpinski-Tetraeder ‚Äì Projekt</h1>
        <span class="muted" data-i18n="app.subtitle">Experiment, Dokumentation und Materialien</span>
      </div>
      <div class="header-right">
        <div id="manifestChip" class="manifest-chip" title="manifest.json">
          <span class="dot" id="manifestDot"></span>
          <span id="manifestText">manifest‚Ä¶</span>
        </div>
        <div class="lang">
          <label for="langSelect" data-i18n="app.language">Sprache</label>
          <select id="langSelect" aria-label="Language">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="app">
      <aside class="left">
        <div class="section"><h2 data-i18n="browser.title">Dateibrowser</h2></div>
        <div class="search">
          <input id="q" type="search" placeholder="Suchen ‚Ä¶"
                 data-i18n="search" data-i18n-attr="placeholder" data-i18n-search="search.placeholder">
        </div>
        <div class="crumb" id="crumb"></div>
        <ul id="list" class="list"></ul>
      </aside>

      <section class="right">
        <div class="viewer">
          <div class="bar">
            <div class="muted" id="currentName">‚Äî</div>
            <div class="btns">
              <button id="btnOpenRaw" class="btn" data-i18n="viewer.openRaw">Rohdatei √∂ffnen</button>
              <button id="btnPdf" class="btn" data-i18n="viewer.downloadPdf">Als PDF exportieren</button>
              <button id="btnRunPy" class="btn" style="display:none" data-i18n="viewer.runPy">Python ausf√ºhren</button>
            </div>
          </div>
          <article id="md" class="md" hidden></article>
          <div id="generic" class="generic" hidden></div>
        </div>
      </section>
    </section>
  </main>

  <footer>
    <div class="container inner">
      <span id="copyright"></span>
      <span class="muted">antaris82.github.io</span>
    </div>
  </footer>

  <script>
    /* ===== Manifest-basierter Browser + Viewer ===== */
    let MANIFEST = null;
    let NODES = new Map(), CHILDREN = new Map();
    let cwd = "", lastMdBasePath = null, currentRawUrl = null;

    const pathDir = p => (p.split("/").slice(0, -1).join("/"));
    const baseName = p => (p.split("/").pop() || "");
    const ext = name => (name.toLowerCase().match(/\.([a-z0-9]+)$/)?.[1] || "");
    const isTextExt = e => ["txt","log","md","markdown","csv","tsv","json","xml","yml","yaml","ini","conf","sh","py","js","ts","css","html","svg","java","c","cpp","h","hpp","cs","go","rs","php","rb","kt","swift","sql","toml"].includes(e);
    const isImageExt = e => ["png","jpg","jpeg","gif","webp","avif","bmp","svg"].includes(e);
    const isAudioExt = e => ["mp3","wav","ogg","m4a","aac","flac"].includes(e);
    const isVideoExt = e => ["mp4","webm","ogv","mov"].includes(e);
    const isPdfExt = e => e === "pdf";
    const fmtSize = b => { if (b==null||isNaN(b)) return ""; const u=["B","KB","MB","GB","TB"]; let i=0,n=+b; while(n>=1024&&i<u.length-1){n/=1024;i++;} return (Math.round(n*10)/10)+" "+u[i]; };
    const urlFor = p => encodeURI((p || "").replace(/^\/+/, ""));
    async function fetchJSON(u){ const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); }
    async function fetchText(u){ const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.text(); }
    async function fetchArrayBuffer(u){ const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.arrayBuffer(); }

    // LaTeX-Delimiter-Fix (au√üerhalb von Code): \(...\)/\[...\] -> $...$/$$...$$
    function convertLatexDelimiters(src) {
      let out="", i=0, inFence=false, inInline=false;
      const starts = s => src.startsWith(s, i);
      while (i < src.length) {
        if (!inInline && starts("```")) { inFence = !inFence; out += "```"; i += 3; continue; }
        if (!inFence && src[i] === "`") { inInline = !inInline; out += src[i++]; continue; }
        if (!inFence && !inInline) {
          if (starts("\\(")) { out += "$"; i += 2; continue; }
          if (starts("\\)")) { out += "$"; i += 2; continue; }
          if (starts("\\[")) { out += "$$"; i += 2; continue; }
          if (starts("\\]")) { out += "$$"; i += 2; continue; }
        }
        out += src[i++];
      }
      return out;
    }

    // i18n-Helfer f√ºr Run-Button
    function setRunPyVisible(show){
      const btn = document.getElementById("btnRunPy");
      btn.style.display = show ? "inline-block" : "none";
      if (!show) btn.onclick = null;
    }

    function normalizeEntries(raw) {
      const out = [];
      const take = (e) => {
        let p = e.path || e.file || null; if (!p) return; p = p.replace(/^\/+/,"");
        let t = e.type; if (t === "blob") t = "file"; if (t === "tree") t = "dir"; if (!t) t = "file";
        const node = { path: p, name: baseName(p), type: (t === "dir" ? "dir" : "file") };
        if (typeof e.size === "number") node.size = e.size;
        out.push(node);
      };
      if (Array.isArray(raw)) raw.forEach(take);
      else if (raw && typeof raw === "object") {
        if (Array.isArray(raw.entries)) raw.entries.forEach(take);
        else if (Array.isArray(raw.tree)) raw.tree.forEach(take);
        else if (Array.isArray(raw.items)) raw.items.forEach(take);
      }
      return out;
    }
    function indexEntries(nodes) {
      NODES.clear(); CHILDREN.clear();
      for (const n of nodes) NODES.set(n.path, n);
      for (const n of nodes) {
        const parts = n.path.split("/").slice(0, -1); let acc = "";
        for (const seg of parts) { acc = acc ? acc + "/" + seg : seg; if (!NODES.has(acc)) NODES.set(acc, { path: acc, name: seg, type: "dir" }); }
      }
      for (const n of NODES.values()) {
        const parent = pathDir(n.path);
        if (!CHILDREN.has(parent)) CHILDREN.set(parent, []);
        CHILDREN.get(parent).push(n);
      }
      for (const [k, arr] of CHILDREN) {
        arr.sort((a,b)=> (a.type!==b.type) ? (a.type==="dir"?-1:1) : a.name.localeCompare(b.name, undefined, {numeric:true}));
      }
    }

    function crumbHtml(path){ const parts = path ? path.split("/").filter(Boolean) : []; const items = ['<a href="#" data-path="">/</a>']; let acc=""; for (const p of parts){ acc = acc ? acc + "/" + p : p; items.push(`<a href="#" data-path="${acc}">${p}</a>`);} return items.join(" / "); }
    function renderCrumb(){ const el=document.getElementById("crumb"); el.innerHTML = crumbHtml(cwd);
      el.querySelectorAll("a").forEach(a=> a.addEventListener("click",(e)=>{e.preventDefault(); openDir(a.dataset.path||"");})); }
    function renderList(){
      const q=(document.getElementById("q").value||"").trim().toLowerCase(); const list=document.getElementById("list"); list.innerHTML="";
      if (cwd){ const up=document.createElement("li"); up.className="item";
        up.innerHTML=`<span class="meta">‚¨ÜÔ∏è</span><span class="name" data-i18n="viewer.up">.. (Ebene h√∂her)</span><span class="meta">UP</span>`;
        up.addEventListener("click", ()=> openDir(pathDir(cwd))); list.appendChild(up); I18n.apply(); }
      const children=(CHILDREN.get(cwd)||[]).filter(e=> !q || e.name.toLowerCase().includes(q));
      if (!children.length){ const li=document.createElement("li"); li.className="item";
        li.innerHTML=`<span class="meta">‚Äî</span><span class="name" data-i18n="browser.empty">Keine Dateien gefunden.</span><span class="meta"></span>`;
        list.appendChild(li); I18n.apply(); return; }
      for (const e of children){
        const li=document.createElement("li"); li.className="item"; li.dataset.path=e.path;
        const icon = e.type==="dir" ? "üìÅ" : "üìÑ"; const extension = e.type==="dir" ? "DIR" : (ext(e.name).toUpperCase()||"FILE"); const size = e.type==="dir" ? "" : fmtSize(e.size);
        li.innerHTML=`<span class="meta">${icon}</span><span class="name">${e.name}</span><span class="meta">${extension}${size?" ‚Ä¢ "+size:""}</span>`;
        li.addEventListener("click", ()=>{ document.querySelectorAll(".item.active").forEach(n=>n.classList.remove("active")); li.classList.add("active"); if (e.type==="dir") openDir(e.path); else openFile(e.path); });
        list.appendChild(li);
      }
    }
    async function openDir(path=""){ cwd=path; renderCrumb(); renderList(); }

    function updateManifestChip(){
      const dot=document.getElementById("manifestDot"), txt=document.getElementById("manifestText");
      try {
        const files=[...NODES.values()].filter(n=>n.type==="file").length;
        const dirs=[...NODES.values()].filter(n=>n.type==="dir").length;
        const t=MANIFEST?.indexedAt||MANIFEST?.generatedAt||MANIFEST?.timestamp||null;
        const d=t?new Date(t):new Date(); const locale=(I18n&&I18n.lang==="en")?"en-GB":"de-DE";
        const stamp=d.toLocaleString(locale,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
        txt.textContent=`${files} ${I18n.t("status.files","Dateien")} ‚Ä¢ ${dirs} ${I18n.t("status.folders","Ordner")} ‚Ä¢ ${I18n.t("status.indexedAt","Stand")}: ${stamp}`;
        dot.classList.add("ok");
      } catch { dot.classList.remove("ok"); dot.classList.add("err"); txt.textContent=I18n.t("status.manifestInvalid","Manifest ung√ºltig"); }
    }

    // Markdown rendern (inkl. KaTeX & Highlighting)
    function showMd(html, titleText){
      const md=document.getElementById("md"), gen=document.getElementById("generic");
      setRunPyVisible(false);
      gen.hidden=true; gen.innerHTML=""; md.hidden=false; md.innerHTML=html;
      document.getElementById("currentName").textContent=titleText||"‚Äî";
      document.querySelectorAll("#md pre code").forEach(block=>hljs.highlightElement(block));
      try {
        renderMathInElement(md,{ delimiters:[
          {left:"$$", right:"$$", display:true},
          {left:"\\[", right:"\\]", display:true},
          {left:"\\(", right:"\\)", display:false},
          {left:"$", right:"$", display:false}
        ], throwOnError:false });
      } catch(e){ console.warn("katex render failed", e); }
    }
    function showGeneric(node,titleText){
      const md=document.getElementById("md"), gen=document.getElementById("generic");
      md.hidden=true; md.innerHTML=""; gen.hidden=false; gen.innerHTML=""; gen.appendChild(node);
      document.getElementById("currentName").textContent=titleText||"‚Äî";
    }
    function existsInManifest(path){ return NODES.has((path||"").replace(/^\/+/,"")); }

    async function openMarkdown(path){
      lastMdBasePath = path.replace(/\.en\.md$/i, ".md").replace(/\.de\.md$/i, ".md");
      const lang = I18n.lang || "de"; let chosen = path.toLowerCase();
      if (lang==="en"){
        if (chosen.endsWith(".md") && !chosen.endsWith(".en.md")){
          const cand = path.replace(/\.md$/i, ".en.md"); if (existsInManifest(cand)) path=cand;
        }
        if (chosen.endsWith(".de.md")){
          const cand = path.replace(/\.de\.md$/i, ".en.md"); if (existsInManifest(cand)) path=cand;
        }
      }
      chosen = path;

      currentRawUrl = urlFor(chosen);
      document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
      document.getElementById("btnPdf").onclick=()=>window.print();

      try{
        let text = await fetchText(currentRawUrl);
        text = convertLatexDelimiters(text);
        marked.setOptions({ breaks:false });
        const html = DOMPurify.sanitize(marked.parse(text));
        showMd(html, chosen.split("/").pop());
        document.querySelector(".right").scrollTop=0;
      } catch(e){
        const p=document.createElement("p"); p.style.color="#ff8080";
        p.textContent=`${I18n.t("errors.loadFailed","Datei konnte nicht geladen werden")}: ${e.message}`;
        showGeneric(p, chosen.split("/").pop());
      }
    }

    async function openText(path){
      currentRawUrl = urlFor(path);
      const btnRun = document.getElementById("btnRunPy");
      document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
      document.getElementById("btnPdf").onclick=()=>window.print();

      const pre=document.createElement("pre"); pre.className="codebox";
      const codeEl=document.createElement("code"); pre.appendChild(codeEl);

      const out=document.createElement("pre"); out.className="codebox"; out.style.marginTop="12px"; out.title="stdout / stderr";

      try{
        const text = await fetchText(currentRawUrl);
        codeEl.textContent = text;
        const language = ext(path); if (language) codeEl.className=`language-${language}`;
        hljs.highlightElement(codeEl);
      } catch(e){
        codeEl.textContent=`${I18n.t("errors.loadFailed","Datei konnte nicht geladen werden")}: ${e.message}`;
      }

      const wrap=document.createElement("div");
      wrap.appendChild(pre);

      if (ext(path) === "py") {
        setRunPyVisible(true);
        btnRun.onclick = () => runPython(codeEl.textContent, out, btnRun);
        const hint=document.createElement("div"); hint.className="muted"; hint.style.margin="6px 0 2px";
        hint.innerHTML = I18n?.lang==="en"
          ? `Tip: Many packages are available (<code>numpy</code>, <code>matplotlib</code>, <code>pillow</code>). Use:<br><code>import io, base64; buf=io.BytesIO(); plt.savefig(buf, format="png"); print("DATA:image/png;base64,"+base64.b64encode(buf.getvalue()).decode())</code><br>Animations: <code>PillowWriter</code> ‚Üí prints <code>WROTE: anim.gif</code>.`
          : `Tipp: Viele Pakete sind verf√ºgbar (<code>numpy</code>, <code>matplotlib</code>, <code>pillow</code>). Plot als Bild zeigen:<br><code>import io, base64; buf=io.BytesIO(); plt.savefig(buf, format="png"); print("DATA:image/png;base64,"+base64.b64encode(buf.getvalue()).decode())</code><br>Animationen: <code>PillowWriter</code> ‚Üí Ausgabe <code>WROTE: anim.gif</code>.`;
        wrap.appendChild(hint);
        wrap.appendChild(out);
      } else {
        setRunPyVisible(false);
      }

      showGeneric(wrap, path.split("/").pop());
    }

    async function openCsv(path){
      setRunPyVisible(false);
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
      document.getElementById("btnPdf").onclick=()=>window.print();
      const wrap=document.createElement("div");
      try{
        const text=await fetchText(currentRawUrl); const parsed=Papa.parse(text.trim());
        const table=document.createElement("table"); table.className="md";
        parsed.data.forEach((row,i)=>{ const tr=document.createElement("tr"); row.forEach(cell=>{ const td=document.createElement(i===0?"th":"td"); td.textContent=cell; tr.appendChild(td); }); table.appendChild(tr); });
        wrap.appendChild(table);
      }catch(e){ const p=document.createElement("p"); p.style.color="#ff8080"; p.textContent=`${I18n.t("errors.loadFailed","Datei konnte nicht geladen werden")}: ${e.message}`; wrap.appendChild(p); }
      showGeneric(wrap, path.split("/").pop());
    }

    async function openPdf(path){
      setRunPyVisible(false);
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
      document.getElementById("btnPdf").onclick=()=>window.print();

      if (typeof window.pdfjsLib === "undefined") {
        const frame=document.createElement("iframe"); frame.className="preview"; frame.src=currentRawUrl; frame.title=path.split("/").pop(); frame.style.height="78vh";
        showGeneric(frame, path.split("/").pop()); return;
      }
      const container=document.createElement("div"); container.className="preview";
      container.style.padding="16px"; container.style.background="#0f1922"; container.style.borderRadius="10px";
      container.style.maxWidth="980px"; container.style.margin="0 auto";
      try{
        const data=await fetchArrayBuffer(currentRawUrl);
        const pdf=await pdfjsLib.getDocument({ data }).promise;
        for (let n=1;n<=pdf.numPages;n++){
          const page=await pdf.getPage(n), viewport=page.getViewport({ scale:1.5 });
          const canvas=document.createElement("canvas"), ctx=canvas.getContext("2d");
          canvas.width=viewport.width; canvas.height=viewport.height; canvas.style.display="block"; canvas.style.margin="0 auto 12px";
          await page.render({ canvasContext:ctx, viewport }).promise;
          container.appendChild(canvas);
        }
        showGeneric(container, path.split("/").pop());
      }catch(e){
        const frame=document.createElement("iframe"); frame.className="preview"; frame.src=currentRawUrl; frame.title=path.split("/").pop(); frame.style.height="78vh";
        showGeneric(frame, path.split("/").pop());
      }
    }

    function openImage(path){
      setRunPyVisible(false);
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
      document.getElementById("btnPdf").onclick=()=>window.print();
      const img=document.createElement("img"); img.className="preview"; img.src=currentRawUrl; img.alt=path.split("/").pop();
      showGeneric(img, img.alt);
    }
    function openAudio(path){
      setRunPyVisible(false);
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
      document.getElementById("btnPdf").onclick=()=>window.print();
      const audio=document.createElement("audio"); audio.className="preview"; audio.controls=true; audio.src=currentRawUrl;
      showGeneric(audio, path.split("/").pop());
    }
    function openVideo(path){
      setRunPyVisible(false);
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
      document.getElementById("btnPdf").onclick=()=>window.print();
      const video=document.createElement("video"); video.className="preview"; video.controls=true; video.src=currentRawUrl;
      showGeneric(video, path.split("/").pop());
    }
    function openRawFile(path){
      setRunPyVisible(false);
      currentRawUrl = urlFor(path);
      document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
      document.getElementById("btnPdf").onclick=()=>window.print();
      const frame=document.createElement("iframe"); frame.className="preview"; frame.src=currentRawUrl; frame.title=path.split("/").pop(); frame.style.height="78vh";
      showGeneric(frame, path.split("/").pop());
    }
    function openFile(path){
      const e=ext(path);
      if (e==="md"||e==="markdown"||e==="mdown") return openMarkdown(path);
      if (isPdfExt(e)) return openPdf(path);
      if (isImageExt(e)) return openImage(path);
      if (isAudioExt(e)) return openAudio(path);
      if (isVideoExt(e)) return openVideo(path);
      if (e==="csv"||e==="tsv") return openCsv(path);
      if (isTextExt(e)) return openText(path);
      return openRawFile(path);
    }

    async function loadManifest(){
      try {
        const m = await fetchJSON(`manifest.json?ts=${Date.now()}`);
        MANIFEST = m; const norm = normalizeEntries(m);
        if (!norm.length) throw new Error("manifest.json enth√§lt keine Eintr√§ge.");
        indexEntries(norm); return true;
      } catch(e){
        console.error("manifest.json laden fehlgeschlagen:", e);
        MANIFEST = {}; NODES.clear(); CHILDREN.clear(); NODES.set("", { path:"", name:"", type:"dir" }); CHILDREN.set("", []);
        const list=document.getElementById("list");
        if (list) list.innerHTML = `<li class="item"><span class="meta">‚ö†Ô∏è</span><span class="name">manifest.json konnte nicht geladen werden. √úber HTTPS/Pages oder lokalen Server √∂ffnen.</span><span class="meta"></span></li>`;
        return false;
      }
    }
    function updateManifestUI(){ updateManifestChip(); renderList(); }
    function renderFooter(){
      const y=new Date().getFullYear();
      document.getElementById("copyright").textContent =
        I18n.lang==="en" ? `¬© ${y} antaris ‚Äî Code: MIT; Data/Figures/Texts (incl. PDFs): CC BY 4.0.`
                         : `¬© ${y} antaris ‚Äî Code: MIT; Daten/Abbildungen/Texte (inkl. PDFs): CC BY 4.0.`;
    }

    // Initiale Vorschau: ST.png im Root anzeigen (falls vorhanden)
    function openInitialPreview(){
      const candidate = "ST.png";
      if (existsInManifest(candidate)) {
        // Item im Browser markieren (optional)
        const item = Array.from(document.querySelectorAll("#list .item"))
          .find(li => li.dataset.path === candidate);
        if (item) {
          document.querySelectorAll("#list .item.active").forEach(n=>n.classList.remove("active"));
          item.classList.add("active");
        }
        openImage(candidate);
      }
    }

    document.getElementById("q").addEventListener("input", renderList);
    document.getElementById("langSelect").addEventListener("change", async (e)=>{
      await I18n.set(e.target.value); renderFooter(); updateManifestUI(); if (lastMdBasePath) openMarkdown(lastMdBasePath);
    });

    document.addEventListener("DOMContentLoaded", async ()=>{
      if (location.protocol === "file:") {
        const list=document.getElementById("list");
        if (list) list.innerHTML = `<li class="item"><span class="meta">‚ÑπÔ∏è</span><span class="name">Bitte via lokalen Server (z. B. <code>python -m http.server</code>) oder GitHub Pages √∂ffnen. <code>file://</code> blockiert <code>fetch</code>.</span><span class="meta"></span></li>`;
        return;
      }
      await I18n.init({ defaultLang: "de" });
      renderFooter();
      await loadManifest();
      updateManifestUI();
      await openDir("");          // Start im Root
      openInitialPreview();       // ST.png anzeigen, wenn vorhanden
    });
  </script>
</body>
</html>
