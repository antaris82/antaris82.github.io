<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sierpinski Reader</title>
  <style>
    :root {
      --bg:#0b1117; --panel:#0e141b; --muted:#8aa0b4; --fg:#e7eef5;
      --accent:#5ba8ff; --border:#1b2632; --ok:#37c978; --warn:#ffb020; --err:#ff5a5a;
      --content-max:1320px; --content-pad:32px;
    }
    html,body{height:100%}
    body{margin:0;color:var(--fg);background:#0b1117;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",Arial}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
    .container{width:min(var(--content-max),100% - var(--content-pad)*2);margin:0 auto}
    header{position:sticky;top:0;z-index:3;background:var(--panel);border-bottom:1px solid var(--border)}
    header .inner{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    .title{display:flex;gap:12px;align-items:baseline}.title h1{margin:0;font-size:18px}.title span{color:var(--muted);font-size:13px}
    .header-right{display:flex;align-items:center;gap:10px}
    .manifest-chip{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 8px;border-radius:8px;background:#0c131a;white-space:nowrap}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--warn)}.dot.ok{background:var(--ok)}.dot.err{background:var(--err)}
    .refresh{background:#0f1922;border:1px solid #26303c;color:var(--fg);padding:6px 10px;border-radius:8px;cursor:pointer}
    .refresh:hover{background:#122436}
    .app{display:grid;grid-template-columns:360px 1fr;min-height:calc(100vh - 56px);gap:24px;padding:18px 0 28px}
    .left,.right{border:1px solid var(--border);background:#0c1218;border-radius:12px;overflow:auto}
    .left .section{padding:12px 14px;border-bottom:1px solid var(--border)}
    .section h2{margin:0 0 8px;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    .search{padding:0 14px 12px;border-bottom:1px solid var(--border)} .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #24303c;background:#0f1720;color:var(--fg)}
    .crumb{padding:8px 14px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)} .crumb a{color:var(--muted)} .crumb a:hover{color:var(--fg)}
    .list{list-style:none;margin:0;padding:6px}
    .item{display:grid;grid-template-columns:24px 1fr auto auto;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;cursor:pointer;color:#fff}
    .item:hover{background:#111a23}.item .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.item .meta{color:var(--muted);font-size:12px}.item.active{background:#122236}
    .linkbtn{background:#0f1922;border:1px solid #26303c;color:var(--fg);padding:4px 6px;border-radius:8px;cursor:pointer;font-size:12px}
    .linkbtn:hover{background:#122436}
    .viewer{padding:18px 22px 60px}
    .viewer .bar{display:flex;align-items:center;gap:8px;justify-content:space-between;position:sticky;top:0;padding:10px 0;background:#0c1218;z-index:2}
    .viewer .btns{display:flex;gap:8px}
    .btn{background:#0f1922;border:1px solid #26303c;color:var(--fg);padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn:hover{background:#122436}
    .md,.generic{max-width:980px;margin:0 auto}
    .viewer .preview,.viewer img.preview,.viewer video.preview,.viewer audio.preview{width:100%;max-width:980px;border:1px solid #223042;border-radius:10px;background:#0f1922;display:block;margin:0 auto}
    .viewer img.preview{height:auto}
    footer{border-top:1px solid var(--border);padding:10px 0;color:var(--muted);background:#0f1218} footer .inner{display:flex;align-items:center;justify-content:space-between}
    @media print{header,.left,.viewer .bar,footer{display:none !important}.app{display:block}body{background:#fff;color:#000}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/legacy/build/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/legacy/build/pdf.worker.min.js";</script>
  <!-- KaTeX local (no CDN fallback per your simplification) -->
  <link rel="stylesheet" href="/assets/katex/katex.min.css">
  <script defer src="/assets/katex/katex.min.js"></script>
  <script defer src="/assets/katex/contrib/auto-render.min.js"></script>
</head>
<body>
<header>
  <div class="container inner">
    <div class="title">
      <h1>Sierpinski-Tetraeder ‚Äì Projekt</h1>
      <span class="muted">Experiment, Dokumentation und Materialien</span>
    </div>
    <div class="header-right">
      <button id="btnRefresh" class="refresh" title="Index aktualisieren">‚Üª</button>
      <div id="manifestChip" class="manifest-chip" title="manifest.json">
        <span class="dot" id="manifestDot"></span>
        <span id="manifestText">manifest‚Ä¶</span>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <section class="app">
    <aside class="left">
      <div class="section"><h2>Dateibrowser</h2></div>
      <div class="search"><input id="q" type="search" placeholder="Suchen ‚Ä¶"></div>
      <div class="crumb" id="crumb"></div>
      <ul id="list" class="list"></ul>
    </aside>

    <section class="right">
      <div class="viewer">
        <div class="bar">
          <div class="muted" id="currentName">‚Äî</div>
          <div class="btns">
            <button id="btnOpenRaw" class="btn">Rohdatei √∂ffnen</button>
            <button id="btnCopyLink" class="btn">Link kopieren</button>
            <button id="btnPdf" class="btn">Als PDF exportieren</button>
          </div>
        </div>
        <article id="md" class="md" hidden></article>
        <div id="generic" class="generic" hidden></div>
      </div>
    </section>
  </section>
</main>

<footer>
  <div class="container inner">
    <span id="copyright"></span>
    <span class="muted">antaris82.github.io</span>
  </div>
</footer>

<script>
/* ===== Config (strict) ===== */
const START_DIR   = "Sierpinski Tetraeder_PoC";  // root folder
const START_IMAGE = "Sierpinski-Tetraeder.png";  // root image
const READER_BASE = "https://antaris82.github.io/";


/* ===== KaTeX loader (local-only) ===== */
function ensureKatexLocal() {
  if (window.renderMathInElement) return Promise.resolve();
  // Wait up to ~3s for the already-included <script defer> tags to finish loading
  return new Promise((resolve, reject) => {
    let ticks = 0;
    const step = () => {
      if (window.renderMathInElement) { resolve(); return; }
      ticks++;
      if (ticks > 60) { reject(new Error("KaTeX auto-render not available")); return; }
      setTimeout(step, 50);
    };
    step();
  });
}
function renderMathNow(container){
  try{
    if (window.renderMathInElement) {
      window.renderMathInElement(container, {
        delimiters:[
          {left:"$$", right:"$$", display:true},
          {left:"\\[", right:"\\]", display:true},
          {left:"\\(", right:"\\)", display:false},
          {left:"$",  right:"$",  display:false}
        ],
        throwOnError:false,
        strict:"ignore"
      });
    }
  }catch(e){ console.warn("KaTeX render error:", e); }
}

/* ===== State & utils ===== */
let MANIFEST=null; let NODES=new Map(), CHILDREN=new Map(); let cwd="", currentRawUrl=null, currentShareUrl=null;

const pathDir=p=> (p.split("/").slice(0,-1).join("/"));
const baseName=p=> (p.split("/").pop()||"");
const ext=name=> (name.toLowerCase().match(/\.([a-z0-9]+)$/)?.[1]||"");
const isTextExt=e=>["txt","log","md","markdown","csv","tsv","json","xml","yml","yaml","ini","conf","sh","py","js","ts","css","html","svg","java","c","cpp","h","hpp","cs","go","rs","php","rb","kt","swift","sql","toml"].includes(e);
const isImageExt=e=>["png","jpg","jpeg","gif","webp","avif","bmp","svg"].includes(e);
const isAudioExt=e=>["mp3","wav","ogg","m4a","aac","flac"].includes(e);
const isVideoExt=e=>["mp4","webm","ogv","mov"].includes(e);
const isPdfExt=e=>e==="pdf";
const fmtSize=b=>{if(b==null||isNaN(b))return"";const u=["B","KB","MB","GB","TB"];let i=0,n=+b;while(n>=1024&&i<u.length-1){n/=1024;i++;}return (Math.round(n*10)/10)+" "+u[i];};
const urlFor=p=> encodeURI((p||"").replace(/^\/+/,""));
const computeShareLink=path=> READER_BASE + "?path=" + encodeURIComponent((path||"").replace(/^\/+/,""));
const getQueryPath=()=>{try{const u=new URL(location.href);return u.searchParams.get("path")?decodeURIComponent(u.searchParams.get("path")):null;}catch{return null;}};
const updateUrlParam=path=>{try{const u=new URL(location.href); if(path){u.searchParams.set("path",path.replace(/^\/+/, ""));} else {u.searchParams.delete("path");} history.replaceState(null,"",u.toString());}catch{}};
const fetchJSON=async(u)=>{const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(r.status+" "+r.statusText); return r.json();};
const fetchText=async(u)=>{const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(r.status+" "+r.statusText); return r.text();};
const fetchArrayBuffer=async(u)=>{const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(r.status+" "+r.statusText); return r.arrayBuffer();};

/* ===== Manifest ===== */
function normalizeEntries(raw){
  const out=[];
  const take=e=>{
    let p=e.path||e.file||null; if(!p) return;
    p=String(p).replace(/^\/+/,"");
    let t=e.type; if(t==="blob") t="file"; if(t==="tree") t="dir"; if(!t) t="file";
    const n={path:p,name:baseName(p),type:(t==="dir"?"dir":"file")};
    if(typeof e.size==="number") n.size=e.size;
    out.push(n);
  };
  if(Array.isArray(raw)) raw.forEach(take);
  else if(raw&&typeof raw==="object"){
    (raw.entries||raw.tree||raw.items||[]).forEach(take);
  }
  return out;
}
function indexEntries(nodes){
  NODES.clear(); CHILDREN.clear();
  for(const n of nodes) NODES.set(n.path,n);
  for(const n of nodes){
    const parts=n.path.split("/").slice(0,-1); let acc="";
    for(const seg of parts){ acc=acc?acc+"/"+seg:seg; if(!NODES.has(acc)) NODES.set(acc,{path:acc,name:seg,type:"dir"}); }
  }
  for(const n of NODES.values()){
    const parent=pathDir(n.path);
    if(!CHILDREN.has(parent)) CHILDREN.set(parent,[]);
    CHILDREN.get(parent).push(n);
  }
  for(const [k,arr] of CHILDREN){
    arr.sort((a,b)=> (a.type!==b.type)?(a.type==="dir"?-1:1):a.name.localeCompare(b.name,undefined,{numeric:true}));
  }
}
async function loadManifest(){
  try{
    const m=await fetchJSON("manifest.json?ts="+Date.now());
    MANIFEST=m;
    const norm=normalizeEntries(m);
    indexEntries(norm);
    const files=[...NODES.values()].filter(n=>n.type==="file").length;
    const dirs=[...NODES.values()].filter(n=>n.type==="dir").length;
    document.getElementById("manifestDot").className="dot ok";
    document.getElementById("manifestText").textContent=`${files} Dateien ‚Ä¢ ${dirs} Ordner`;
  }catch(e){
    console.error("manifest.json laden fehlgeschlagen:", e);
    MANIFEST={}; NODES.clear(); CHILDREN.clear(); NODES.set("",{path:"",name:"",type:"dir"}); CHILDREN.set("",[]);
    document.getElementById("manifestDot").className="dot err";
    document.getElementById("manifestText").textContent="Manifest fehlt";
  }
}

/* ===== Browser UI ===== */
function crumbHtml(path){const parts=path?path.split("/").filter(Boolean):[]; const items=['<a href="#" data-path="">/</a>']; let acc=""; for(const p of parts){acc=acc?acc+"/"+p:p; items.push(`<a href="#" data-path="${acc}">${p}</a>`);} return items.join(" / ");}
function renderCrumb(){const el=document.getElementById("crumb"); el.innerHTML=crumbHtml(cwd); el.querySelectorAll("a").forEach(a=>a.addEventListener("click",e=>{e.preventDefault(); openDir(a.dataset.path||"");}));}
function renderList(){
  const q=(document.getElementById("q").value||"").trim().toLowerCase();
  const list=document.getElementById("list"); list.innerHTML="";
  if(cwd){
    const up=document.createElement("li"); up.className="item";
    up.innerHTML=`<span class="meta">‚¨ÜÔ∏è</span><span class="name">.. (Ebene h√∂her)</span><span class="meta">UP</span><span class="meta"></span>`;
    up.addEventListener("click",()=>openDir(pathDir(cwd)));
    list.appendChild(up);
  }
  const children=(CHILDREN.get(cwd)||[]).filter(e=>!q||e.name.toLowerCase().includes(q));
  if(!children.length){
    const li=document.createElement("li"); li.className="item";
    li.innerHTML=`<span class="meta">‚Äî</span><span class="name">Keine Dateien gefunden.</span><span class="meta"></span><span class="meta"></span>`;
    list.appendChild(li); return;
  }
  for(const e of children){
    const li=document.createElement("li"); li.className="item"; li.dataset.path=e.path;
    const icon=e.type==="dir"?"üìÅ":"üìÑ";
    const extension=e.type==="dir"?"DIR":(ext(e.name).toUpperCase()||"FILE");
    const size=e.type==="dir"?"":fmtSize(e.size);
    li.innerHTML = `<span class="meta">${icon}</span>
                    <span class="name">${e.name}</span>
                    <span class="meta">${extension}${size?" ‚Ä¢ "+size:""}</span>
                    <span class="meta">${e.type==="file" ? "<button class='linkbtn' title='Link kopieren' aria-label='Link kopieren'>üîó</button>" : ""}</span>`;
    li.addEventListener("click",()=>{
      document.querySelectorAll(".item.active").forEach(n=>n.classList.remove("active"));
      li.classList.add("active");
      if(e.type==="dir") openDir(e.path); else openFile(e.path);
    });
    if(e.type==="file"){
      const btn=li.querySelector(".linkbtn");
      if(btn){
        btn.addEventListener("click", async (ev)=>{
          ev.stopPropagation();
          const link=READER_BASE + "?path=" + encodeURIComponent(e.path);
          try{ await navigator.clipboard.writeText(link); btn.textContent="‚úì"; setTimeout(()=>btn.textContent="üîó", 900); }
          catch{ window.open(link, "_blank"); }
        });
      }
    }
    list.appendChild(li);
  }
}
async function openDir(path=""){cwd=path; renderCrumb(); renderList();}

/* ===== Viewer ===== */
function setViewerShare(path){
  currentRawUrl = urlFor(path);
  currentShareUrl = READER_BASE + "?path=" + encodeURIComponent(path.replace(/^\/+/,""));
  document.getElementById("btnOpenRaw").onclick=()=>window.open(currentRawUrl,"_blank");
  document.getElementById("btnCopyLink").onclick=async ()=>{
    try{ await navigator.clipboard.writeText(currentShareUrl); const b=document.getElementById("btnCopyLink"); const old=b.textContent; b.textContent="Kopiert!"; setTimeout(()=>b.textContent="Link kopieren", 900); }
    catch{ window.open(currentShareUrl,"_blank"); }
  };
  document.getElementById("btnPdf").onclick=()=>window.print();
  document.getElementById("currentName").textContent = baseName(path)||"‚Äî";
  updateUrlParam(path);
}
function showGeneric(node,titleText){
  const md=document.getElementById("md"), gen=document.getElementById("generic");
  md.hidden=true; md.innerHTML=""; gen.hidden=false; gen.innerHTML=""; gen.appendChild(node);
  document.getElementById("currentName").textContent=titleText||"‚Äî";
}
async function openMarkdown(path){
  setViewerShare(path);
  try{
    const text = await fetchText(currentRawUrl);
    marked.setOptions({gfm:true, breaks:false});
    const html = DOMPurify.sanitize(marked.parse(text));
    const md=document.getElementById("md"); const gen=document.getElementById("generic");
    gen.hidden=true; gen.innerHTML=""; md.hidden=false; md.innerHTML=html;
    document.querySelectorAll("#md pre code").forEach(b=>hljs.highlightElement(b));
    try { await ensureKatexLocal(); renderMathNow(md); } catch(e) { console.warn("KaTeX not ready:", e); }
    if (window.renderMathInElement){ renderMathInElement(md,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\[",right:"\\]",display:true},{left:"\\(",right:"\\)",display:false},{left:"$",right:"$",display:false}],throwOnError:false}); }
  }catch(e){
    const p=document.createElement("p"); p.style.color="#ff8080"; p.textContent=`Datei konnte nicht geladen werden: ${e.message}`;
    showGeneric(p, baseName(path));
  }
}
async function openCsv(path){
  setViewerShare(path);
  const wrap=document.createElement("div");
  try{
    const text=await fetchText(currentRawUrl); const parsed=Papa.parse(text.trim());
    const table=document.createElement("table"); table.className="md";
    parsed.data.forEach((row,i)=>{const tr=document.createElement("tr"); row.forEach(cell=>{const td=document.createElement(i===0?"th":"td"); td.textContent=cell; tr.appendChild(td)}); table.appendChild(tr);});
    wrap.appendChild(table);
  }catch(e){const p=document.createElement("p"); p.style.color="#ff8080"; p.textContent=`Datei konnte nicht geladen werden: ${e.message}`; wrap.appendChild(p);}
  showGeneric(wrap, baseName(path));
}
async function openPdf(path){
  setViewerShare(path);
  const container=document.createElement("div"); container.className="preview";
  container.style.padding="16px"; container.style.background="#0f1922"; container.style.borderRadius="10px";
  container.style.maxWidth="980px"; container.style.margin="0 auto";
  try{
    const data=await fetchArrayBuffer(currentRawUrl);
    const pdf=await pdfjsLib.getDocument({ data }).promise;
    for(let n=1;n<=pdf.numPages;n++){
      const page=await pdf.getPage(n), viewport=page.getViewport({ scale:1.5 });
      const canvas=document.createElement("canvas"), ctx=canvas.getContext("2d");
      canvas.width=viewport.width; canvas.height=viewport.height; canvas.style.display="block"; canvas.style.margin="0 auto 12px";
      await page.render({ canvasContext:ctx, viewport }).promise;
      container.appendChild(canvas);
    }
    showGeneric(container, baseName(path));
  }catch(e){
    const frame=document.createElement("iframe"); frame.className="preview"; frame.src=currentRawUrl; frame.title=baseName(path); frame.style.height="78vh";
    showGeneric(frame, baseName(path));
  }
}
function openImage(path){
  setViewerShare(path);
  const img=document.createElement("img"); img.className="preview"; img.src=currentRawUrl; img.alt=baseName(path);
  showGeneric(img, img.alt);
}
function openAudio(path){
  setViewerShare(path);
  const audio=document.createElement("audio"); audio.className="preview"; audio.controls=true; audio.src=currentRawUrl;
  showGeneric(audio, baseName(path));
}
function openVideo(path){
  setViewerShare(path);
  const video=document.createElement("video"); video.className="preview"; video.controls=true; video.src=currentRawUrl;
  showGeneric(video, baseName(path));
}
function openRawFile(path){
  setViewerShare(path);
  const frame=document.createElement("iframe"); frame.className="preview"; frame.src=currentRawUrl; frame.title=baseName(path); frame.style.height="78vh";
  showGeneric(frame, baseName(path));
}
function openText(path){
  setViewerShare(path);
  const pre=document.createElement("pre"); pre.className="md"; pre.style.padding="12px";
  fetchText(currentRawUrl).then(txt=>{ pre.textContent=txt; }).catch(e=>{ pre.textContent="Datei konnte nicht geladen werden: "+e.message; });
  showGeneric(pre, baseName(path));
}
function openFile(path){
  const e=ext(path);
  if(e==="md"||e==="markdown"||e==="mdown") return openMarkdown(path);
  if(isPdfExt(e)) return openPdf(path);
  if(isImageExt(e)) return openImage(path);
  if(isAudioExt(e)) return openAudio(path);
  if(isVideoExt(e)) return openVideo(path);
  if(e==="csv"||e==="tsv") return openCsv(path);
  if(isTextExt(e)) return openText(path);
  return openRawFile(path);
}

/* ===== Boot (strict, no fallbacks) ===== */
async function boot(){
  await loadManifest();
  await openDir(START_DIR);
  const qp = getQueryPath();
  if (qp) { openFile(qp); } else { openImage(START_IMAGE); }
}
document.getElementById("q").addEventListener("input",renderList);
document.getElementById("btnRefresh").addEventListener("click", ()=>boot());
document.addEventListener("DOMContentLoaded", ()=>{ boot().catch(err=>console.error(err)); });
</script>
</body>
</html>
